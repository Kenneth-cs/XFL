# 数据库迁移手动步骤（本地 → 服务器）

## 方案说明

将本地数据库（数据格式正确）完全替换服务器数据库（有旧格式数据）。

## 执行步骤

### 步骤1：备份服务器数据库（必做！）

```bash
# 在本地终端执行：
ssh -i ~/.ssh/XFL.pem ubuntu@124.222.88.25 "mysqldump -uroot -p'Xinfuli2024!' xinfu_db" > server-backup-$(date +%Y%m%d).sql
```

**验证备份成功：**
```bash
ls -lh server-backup-*.sql
# 应该看到文件大小 > 1MB
```

### 步骤2：导出本地数据库

```bash
# 在本地终端执行：
mysqldump -uroot -p123456 xinfu_db > local-export-$(date +%Y%m%d).sql
```

**验证导出成功：**
```bash
ls -lh local-export-*.sql
# 应该看到文件大小 > 1MB
```

### 步骤3：上传本地数据到服务器

```bash
# 上传SQL文件到服务器
scp -i ~/.ssh/XFL.pem local-export-*.sql ubuntu@124.222.88.25:/tmp/xinfu_import.sql
```

### 步骤4：在服务器上导入数据

```bash
# SSH连接到服务器
ssh -i ~/.ssh/XFL.pem ubuntu@124.222.88.25

# 在服务器上执行：
mysql -uroot -p'Xinfuli2024!' xinfu_db < /tmp/xinfu_import.sql

# 验证导入成功：
mysql -uroot -p'Xinfuli2024!' xinfu_db -e "SELECT COUNT(*) as user_count FROM app_user;"

# 查看幸福力数据：
mysql -uroot -p'Xinfuli2024!' xinfu_db -e "SELECT user_id, LENGTH(result_data) FROM assessment_record WHERE type=3 AND is_latest=1;"

# 清理临时文件
rm /tmp/xinfu_import.sql

# 重启后端服务
pm2 restart xinfu-backend

# 退出SSH
exit
```

### 步骤5：验证功能

1. **清除浏览器缓存**
   - 按 `Ctrl+Shift+Delete`
   - 选择"全部时间"
   - 勾选"缓存的图片和文件"
   - 清除

2. **重新登录后台**
   - 访问：http://124.222.88.25:8080/admin/
   - 使用账号密码登录

3. **测试智能匹配功能**
   - 进入"智能匹配"页面
   - 检查发起方的"幸福圆环"是否显示
   - 检查候选方的"幸福圆环"是否显示

## 回滚方案（如果出问题）

如果导入后发现数据有问题，可以立即回滚：

```bash
ssh -i ~/.ssh/XFL.pem ubuntu@124.222.88.25

# 回滚到备份数据
mysql -uroot -p'Xinfuli2024!' xinfu_db < ~/server-backup-YYYYMMDD.sql

# 重启后端
pm2 restart xinfu-backend
```

## 注意事项

⚠️ **执行前必须确认：**
- ✅ 本地前端能正常显示所有圆环
- ✅ 本地后台匹配列表功能正常
- ✅ 本地数据库包含所有需要的用户数据
- ✅ 已经创建了服务器数据库备份

⚠️ **数据库连接信息：**
- 本地：`root` / `123456` / `xinfu_db`
- 服务器：`root` / `Xinfuli2024!` / `xinfu_db`

## 预期结果

迁移完成后：
- ✅ 所有有幸福力测评数据的用户，圆环都能正常显示
- ✅ 数据格式统一为新格式（包含 dimensions 和 averageScore）
- ✅ 用户档案、匹配记录等其他数据保持一致
