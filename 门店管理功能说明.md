# 门店管理功能说明

## 📋 功能概述

门店管理是"幸福力"系统的多租户架构基础，超级管理员可以创建、编辑、禁用/启用、删除门店，并为每个门店绑定对应的MV计算方案。

---

## 🎯 核心功能点

### 1. MV方案管理

系统预设5套地域化MV计算方案，门店创建时由超级管理员手动选择绑定：

| 方案ID | 方案名称 | 代码标识 | 适用地区 |
|--------|---------|---------|---------|
| 1 | 婚恋价值广东周边地区 | `GUANGDONG` | 广东、广西、福建等 |
| 2 | 婚恋价值江浙周边地区 | `JIANGZHE` | 江苏、浙江、安徽等 |
| 3 | 婚恋价值全国普适版 | `NATIONWIDE` | 全国通用 |
| 4 | 婚恋价值上海北京地区 | `BEIJING_SHANGHAI` | 北京、上海、深圳等 |
| 5 | 婚恋价值东北新疆地区 | `NORTHEAST_XINJIANG` | 东北三省、新疆等 |

**实现文件**：
- 常量定义：`backend/src/constants/mv-template.constant.ts`
- API接口：`GET /api/v1/stores/mv-templates/list`（公开接口）

---

### 2. 门店ID生成规则

**格式**: `XFL` + 3位序列号

**示例**: `XFL001`, `XFL002`, `XFL003`...

**实现逻辑**:
- 使用 Redis 原子递增保证唯一性：`INCR sys:store:seq`
- 序列号补零至3位
- ID生成后不可修改

**实现文件**：`backend/src/shared/services/id-generator.service.ts`

---

### 3. 门店CRUD功能

#### 3.1 创建门店

**权限**: 仅超级管理员

**字段**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 门店名称（唯一性校验） |
| mvTemplateId | number | 是 | MV方案ID (1-5) |
| contactPerson | string | 否 | 联系人姓名 |
| contactPhone | string | 否 | 联系电话 |
| regionInfo | JSON | 否 | 省市区地址信息 |

**API**:
```
POST /api/v1/stores
Authorization: Bearer {超管Token}
Content-Type: application/json

{
  "name": "佛山幸福力分店",
  "mvTemplateId": 1,
  "contactPerson": "张三",
  "contactPhone": "13800138000"
}

返回:
{
  "id": "XFL001",
  "name": "佛山幸福力分店",
  "mvTemplateId": 1,
  "status": 1,
  "createdAt": "2026-01-14T10:00:00Z",
  "updatedAt": "2026-01-14T10:00:00Z"
}
```

**验证规则**:
- 门店名称不能重复（排除已删除的门店）
- MV方案ID必须在1-5之间
- 系统自动生成门店ID
- 默认状态为 `1`（正常）

---

#### 3.2 编辑门店

**权限**: 仅超级管理员

**可编辑字段**:
- ✅ 门店名称
- ✅ MV计算方案（可更换）
- ✅ 联系人
- ✅ 联系电话
- ✅ 地址信息
- ❌ 门店ID（不可修改）

**API**:
```
PATCH /api/v1/stores/{storeId}
Authorization: Bearer {超管Token}

{
  "name": "佛山幸福力旗舰店",
  "mvTemplateId": 3
}
```

**注意事项**:
- 更换MV方案后，该门店所有会员的MV值需要重新计算（后续功能）
- 建议在更换时提示管理员确认

---

#### 3.3 禁用/启用门店

**权限**: 仅超级管理员

**业务逻辑**:
- 禁用门店后（`status = 0`），该门店的后台用户无法登录
- 该门店的前台用户无法注册新会员
- 不影响已有数据的查看

**API**:
```
PATCH /api/v1/stores/{storeId}/toggle-status
Authorization: Bearer {超管Token}

返回:
{
  "id": "XFL001",
  "status": 0  // 0-禁用, 1-启用
}
```

---

#### 3.4 删除门店（软删除）

**权限**: 仅超级管理员

**实现方式**: 软删除（`status = -1`）

**业务逻辑**:
- 门店数据仍保留在数据库中，但在列表中不可见
- 软删除后的门店名称可以被其他新门店重复使用
- 不影响已有的业务数据（用户、匹配记录等）

**API**:
```
DELETE /api/v1/stores/{storeId}
Authorization: Bearer {超管Token}

返回:
{
  "id": "XFL001",
  "status": -1  // -1-已删除
}
```

**注意事项**:
- 删除前应检查门店下是否有关联的用户数据（TODO）
- 建议前端弹出二次确认提示

---

#### 3.5 获取门店列表

**权限**: 公开接口（注册时需要选择门店）

**筛选参数**:
- `status`: 可选，筛选特定状态的门店（1-正常, 0-禁用）
- 默认不显示已删除的门店（`status != -1`）

**API**:
```
GET /api/v1/stores?status=1
Authorization: Bearer {Token} (可选)

返回:
[
  {
    "id": "XFL001",
    "name": "佛山幸福力分店",
    "mvTemplateId": 1,
    "contactPerson": "张三",
    "contactPhone": "13800138000",
    "status": 1,
    "createdAt": "2026-01-14T10:00:00Z",
    "updatedAt": "2026-01-14T10:00:00Z"
  }
]
```

---

## 🔧 实现细节

### 后端架构

#### 文件结构
```
backend/
├── src/
│   ├── constants/
│   │   └── mv-template.constant.ts      # MV方案常量定义
│   ├── entities/
│   │   └── store.entity.ts              # Store实体定义
│   ├── modules/
│   │   └── store/
│   │       ├── store.controller.ts      # Store控制器
│   │       ├── store.service.ts         # Store服务
│   │       └── store.module.ts
│   └── shared/
│       └── services/
│           └── id-generator.service.ts  # ID生成器
```

#### 数据库表结构
```sql
CREATE TABLE IF NOT EXISTS `sys_store` (
  `id` CHAR(6) NOT NULL COMMENT '门店ID (如: XFL001)',
  `name` VARCHAR(50) NOT NULL COMMENT '门店名称',
  `mv_template_id` TINYINT NOT NULL COMMENT 'MV地域方案ID (1-5)',
  `region_info` JSON NULL COMMENT '省市区地址信息',
  `contact_person` VARCHAR(50) NULL COMMENT '联系人',
  `contact_phone` VARCHAR(20) NULL COMMENT '联系电话',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-正常, 0-禁用, -1-已删除(软删除)',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 前端实现

#### 文件位置
- 门店列表页：`frontend-admin/src/views/system/StoresList.vue`

#### 核心功能
1. **门店列表展示**
   - 展示门店ID、名称、MV方案、联系人、联系电话、状态、创建时间
   - 支持分页（前端分页）
   - 状态标签：绿色（正常）、红色（禁用）

2. **新建/编辑门店弹窗**
   - 表单验证：门店名称必填、MV方案必选
   - MV方案下拉框展示完整信息（名称 + 适用地区）
   - 悬浮显示方案描述

3. **操作按钮**
   - 编辑：打开编辑弹窗
   - 禁用/启用：切换门店状态
   - 删除：二次确认后软删除

#### 权限控制
- 菜单级别：仅超级管理员可见"门店列表"菜单项（已在 `DashboardView.vue` 中实现）
- 接口级别：所有写操作（创建、编辑、删除、状态切换）均需 `@Roles(SysUserRole.SUPER_ADMIN)` 守卫

---

## ✅ 测试清单

### 功能测试

#### 1. 创建门店
- [ ] 超级管理员登录后台
- [ ] 点击"新增门店"按钮
- [ ] 填写门店名称"测试门店001"
- [ ] 选择MV方案"婚恋价值全国普适版"
- [ ] 填写联系人"张三"、联系电话"13800138000"
- [ ] 点击"确定"，成功创建
- [ ] 验证门店ID格式为 `XFL001`
- [ ] 验证门店出现在列表中

#### 2. 编辑门店
- [ ] 点击门店的"编辑"按钮
- [ ] 修改门店名称为"测试门店002"
- [ ] 更换MV方案为"婚恋价值广东周边地区"
- [ ] 点击"确定"，成功更新
- [ ] 验证列表中显示更新后的信息

#### 3. 禁用/启用门店
- [ ] 点击"禁用"按钮
- [ ] 验证状态标签变为红色"禁用"
- [ ] 点击"启用"按钮
- [ ] 验证状态标签变为绿色"正常"

#### 4. 删除门店（软删除）
- [ ] 点击"删除"按钮
- [ ] 出现二次确认弹窗
- [ ] 点击"确认"，成功删除
- [ ] 验证门店从列表中消失
- [ ] 数据库中验证 `status = -1`，数据仍存在

#### 5. MV方案查询
- [ ] 在新建门店时，打开MV方案下拉框
- [ ] 验证显示5个方案选项
- [ ] 每个选项显示"方案名称 (适用地区)"
- [ ] 悬浮时显示方案描述

#### 6. 门店ID生成
- [ ] 连续创建3个门店
- [ ] 验证门店ID为 `XFL001`, `XFL002`, `XFL003`
- [ ] 验证ID唯一且连续递增

### 权限测试

#### 1. 超级管理员权限
- [ ] 超级管理员登录
- [ ] 可以看到"门店列表"菜单
- [ ] 可以创建门店
- [ ] 可以编辑任意门店
- [ ] 可以禁用/启用任意门店
- [ ] 可以删除任意门店

#### 2. 其他角色权限
- [ ] 门店老板登录
- [ ] 菜单中不显示"门店列表"
- [ ] 直接访问 `/system/stores` 路由被拦截或显示无权限提示
- [ ] 调用门店创建API返回 `403 Forbidden`

### 异常处理测试

#### 1. 重复门店名称
- [ ] 创建门店时使用已存在的门店名称
- [ ] 验证返回错误提示"门店名称已存在"

#### 2. 无效MV方案ID
- [ ] 尝试提交 `mvTemplateId = 0` 或 `mvTemplateId = 6`
- [ ] 验证返回错误提示"无效的MV方案ID"

#### 3. 必填字段验证
- [ ] 不填写门店名称，点击提交
- [ ] 验证表单验证提示"请输入门店名称"
- [ ] 不选择MV方案，点击提交
- [ ] 验证表单验证提示"请选择MV计算方案"

#### 4. 软删除后名称复用
- [ ] 删除门店"测试门店001"
- [ ] 创建新门店，使用同样的名称"测试门店001"
- [ ] 验证可以成功创建

---

## 📊 数据流程图

```
超级管理员 -> 点击"新增门店" -> 填写表单（选择MV方案） -> 提交
    |
    v
Frontend: 发送 POST /api/v1/stores
    |
    v
Backend: StoreController.create()
    |
    v
Backend: StoreService.create()
    |
    +-- 验证MV方案ID (1-5)
    +-- 检查门店名称唯一性
    +-- 调用 IdGeneratorService.generateStoreId()
    |     |
    |     +-- Redis INCR sys:store:seq
    |     +-- 格式化为 XFL001
    +-- 创建Store实体，保存到数据库
    |
    v
返回门店信息 -> 前端刷新列表 -> 显示新创建的门店
```

---

## 🔄 后续优化方向

### 1. 门店关联数据检查
- 在删除门店前，检查是否有关联的用户数据
- 如果有关联数据，提示"该门店下有XX名用户，无法删除"或"是否强制删除？"

### 2. MV方案更换影响
- 实现MV值重新计算触发器
- 更换MV方案后，自动重新计算该门店所有会员的MV值

### 3. 门店统计信息
- 在门店列表中显示该门店下的用户数量
- 显示该门店的活跃度、匹配成功率等统计数据

### 4. 批量操作
- 支持批量禁用/启用门店
- 支持批量导出门店数据

### 5. 门店图片/Logo
- 添加门店Logo上传功能
- 在前台注册时展示门店Logo

---

## 📝 API接口汇总

| 接口 | 方法 | 权限 | 说明 |
|------|------|------|------|
| `/api/v1/stores` | POST | 超管 | 创建门店 |
| `/api/v1/stores` | GET | 公开 | 获取门店列表 |
| `/api/v1/stores/:id` | GET | 公开 | 获取门店详情 |
| `/api/v1/stores/:id` | PATCH | 超管 | 更新门店信息 |
| `/api/v1/stores/:id/toggle-status` | PATCH | 超管 | 禁用/启用门店 |
| `/api/v1/stores/:id` | DELETE | 超管 | 删除门店（软删除） |
| `/api/v1/stores/mv-templates/list` | GET | 公开 | 获取MV方案列表 |

---

## 🐛 已知问题

暂无

---

## 📅 更新日志

| 日期 | 版本 | 说明 |
|------|------|------|
| 2026-01-14 | v1.0 | 初始版本，完成门店CRUD、MV方案管理、软删除功能 |

