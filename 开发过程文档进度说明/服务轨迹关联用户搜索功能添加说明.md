# 服务轨迹关联用户搜索功能添加说明

## 问题描述

在用户档案的服务轨迹模块（匹配轨迹、约见轨迹、治疗轨迹）中，"关联用户"选择器没有实现有效的模糊搜索功能，用户无法通过关键词、ID或手机号快速查找并选择用户。

## 修复内容

### 1. 后端修改

#### 文件：`backend/src/modules/user/user.controller.ts`

**修改内容：**
- 在 `findAllAppUsers` 方法中新增 `userId` 查询参数
- 支持通过用户ID进行精确搜索

```typescript
@Get('app')
@UseGuards(RolesGuard)
async findAllAppUsers(
  @CurrentUser() user: CurrentUserData,
  @Query('page') pageParam?: string,
  @Query('limit') limitParam?: string,
  @Query('storeId') queryStoreId?: string,
  @Query('name') name?: string,
  @Query('phone') phone?: string,
  @Query('userId') userId?: string,  // 新增：用户ID搜索
) {
  // ... 实现代码
  return await this.userService.findAllAppUsers(targetStoreId, page, limit, user, name, phone, userId);
}
```

#### 文件：`backend/src/modules/user/user.service.ts`

**修改内容：**
- 在 `findAllAppUsers` 方法中添加用户ID查询逻辑
- 支持通过 `user.id` 进行精确匹配

```typescript
async findAllAppUsers(
  storeId?: string, 
  page = 1, 
  limit = 20, 
  currentUser?: CurrentUserData, 
  name?: string, 
  phone?: string, 
  userId?: string  // 新增参数
) {
  const qb = this.appUserRepository.createQueryBuilder('user');
  
  // 门店过滤
  if (storeId) {
    qb.andWhere('user.storeId = :storeId', { storeId });
  }
  
  // 用户ID精确搜索（优先级最高）
  if (userId) {
    qb.andWhere('user.id = :userId', { userId });
  }
  
  // 手机号搜索
  if (phone) {
    qb.andWhere('user.phone LIKE :phone', { phone: `%${phone}%` });
  }
  
  // 姓名搜索（通过JSON字段）
  if (name) {
    qb.leftJoin('app_user_profile', 'profile', 'profile.user_id = user.id');
    qb.andWhere("JSON_EXTRACT(profile.base_info, '$.name') LIKE :name", { name: `%${name}%` });
  }
  
  // ... 其他查询逻辑
}
```

### 2. 前端修改

#### 文件：`frontend-admin/src/views/members/components/ServiceTracks.vue`

**修改内容：**

1. **优化搜索逻辑**：实现智能搜索判断
   - ID搜索：识别 `XFL` 开头的用户ID格式（不区分大小写）
   - 手机号搜索：识别标准手机号格式（1开头的11位数字）
   - 姓名搜索：其他输入视为姓名关键词

```typescript
const handleSearchUser = async (value: string) => {
  if (!value || value.trim().length === 0) {
    searchResults.value = [];
    return;
  }
  
  searchingUser.value = true;
  try {
    const keyword = value.trim();
    
    // 智能判断搜索类型
    const isId = /^XFL\d+$/i.test(keyword); // XFL开头的ID格式
    const isPhone = /^1[3-9]\d{9}$/.test(keyword); // 标准手机号格式
    
    let params: any = { page: 1, limit: 20 };
    
    if (isId) {
      params.userId = keyword.toUpperCase(); // ID精确搜索
    } else if (isPhone) {
      params.phone = keyword; // 手机号搜索
    } else {
      params.name = keyword; // 姓名模糊搜索
    }
    
    const res = await axios.get('/users/app', { params });
    const users = res.items || res.data || [];
    
    searchResults.value = users.map((u: any) => ({
      id: u.id,
      name: u.profile?.baseInfo?.name || u.phone || '未命名'
    }));
    
    if (searchResults.value.length === 0) {
      message.warning('未找到匹配的用户');
    }
  } catch (error) {
    console.error('搜索用户失败:', error);
    message.error('搜索用户失败');
  } finally {
    searchingUser.value = false;
  }
};
```

2. **增强用户体验**：弹窗打开时预加载用户列表

```typescript
const showAddModal = async () => {
  // ... 初始化表单状态
  modalVisible.value = true;
  
  // 预加载一些用户供选择
  await loadInitialUsers();
};

const loadInitialUsers = async () => {
  searchingUser.value = true;
  try {
    const res = await axios.get('/users/app', {
      params: { page: 1, limit: 20 }
    });
    const users = res.items || res.data || [];
    searchResults.value = users.map((u: any) => ({
      id: u.id,
      name: u.profile?.baseInfo?.name || u.phone || '未命名'
    }));
  } catch (error) {
    console.error('加载用户列表失败:', error);
  } finally {
    searchingUser.value = false;
  }
};
```

## 功能特性

### 支持的搜索方式

1. **用户ID搜索**
   - 格式：`XFL` + 数字（如 `XFL00100008`）
   - 搜索方式：精确匹配
   - 不区分大小写

2. **手机号搜索**
   - 格式：1开头的11位数字（如 `13800000001`）
   - 搜索方式：模糊匹配
   - 支持部分手机号搜索

3. **姓名搜索**
   - 格式：任意文本（如 `张三`、`zhang`）
   - 搜索方式：模糊匹配
   - 支持姓名关键词搜索

### 用户体验优化

1. **预加载用户列表**：打开弹窗时自动加载20个用户供快速选择
2. **实时搜索**：输入时实时搜索，无需点击按钮
3. **搜索状态提示**：显示加载状态和搜索结果提示
4. **无结果提示**：搜索无结果时显示友好提示

## 测试验证

### 测试场景

1. **用户ID搜索**
   - 输入完整ID：`XFL00100008` → 应返回精确匹配的用户
   - 输入小写ID：`xfl00100008` → 应能正常搜索（自动转大写）

2. **手机号搜索**
   - 输入完整手机号：`13800000001` → 应返回匹配的用户
   - 输入部分手机号：`138000` → 应返回所有包含该数字的用户

3. **姓名搜索**
   - 输入完整姓名：`张三` → 应返回所有包含"张三"的用户
   - 输入姓名关键词：`张` → 应返回所有姓名包含"张"的用户

4. **预加载测试**
   - 点击"新增记录"按钮 → 弹窗应显示最近的20个用户

### 权限验证

- 门店红娘：只能搜索本门店的用户
- 超级管理员：可以搜索所有门店的用户

## 部署说明

### 1. 后端部署

```bash
cd backend
npm run build
pm2 restart backend
```

### 2. 前端部署

```bash
cd frontend-admin
npm run build
# 将 dist/ 目录内容部署到服务器
```

### 3. 验证部署

1. 登录后台管理系统
2. 进入任意用户档案页面
3. 切换到"匹配轨迹"、"约见轨迹"或"治疗轨迹"标签
4. 点击"新增记录"
5. 在"关联用户"下拉框中：
   - 验证是否预加载了用户列表
   - 输入ID/手机号/姓名进行搜索测试

## 注意事项

1. **搜索性能**：
   - ID搜索：性能最佳（精确匹配）
   - 手机号搜索：性能良好（索引字段）
   - 姓名搜索：性能相对较慢（JSON字段查询，需要联表）

2. **数据权限**：
   - 搜索结果会自动根据当前用户角色和门店进行过滤
   - 门店红娘只能看到本门店的用户

3. **搜索限制**：
   - 默认返回最多20条结果
   - 建议用户输入更具体的搜索关键词以缩小结果范围

## 完成时间

2026-01-27

## 相关文档

- 服务轨迹模块文档：`服务轨迹/服务轨迹模块.md`
- 系统架构文档：`项目核心文档/系统架构与数据库设计_幸福力项目_v1.0.md`
- 后台权限说明：`项目核心文档/后台用户角色及权限.md`
