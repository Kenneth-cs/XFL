# 依恋关系得分不足处理说明

## 需求描述

当用户的依恋关系测试三个维度得分都低于5分时，系统应该：
1. 显示特定的提示文案："三个维度得分都低于5分，无法给出具体的依恋类型"
2. 仍然显示三维度得分详情（焦虑、回避、安全感）
3. 不展示具体类型的解释（核心特质、典型行为表现、相处优势/痛点）

**典型数据示例**：
- 焦虑得分 (A): 3
- 回避得分 (B): 2
- 安全感得分 (C): 3

**预期输出**：显示"得分不足"状态，而非"安全型"、"焦虑型"等具体类型。

---

## 实现方案

### 1. 后端逻辑调整

**文件**：`backend/src/modules/assessment/calculators/attachment.calculator.ts`

**核心修改**：

#### (1) 类型定义更新
```typescript
export interface AttachmentResult {
  anxietyScore: number;
  avoidanceScore: number;
  securityScore: number;
  type: '安全型' | '焦虑型' | '回避型' | '紊乱型' | '得分不足'; // 新增"得分不足"类型
  typeLabel: string;
  description: string;
}
```

#### (2) 判定逻辑
```typescript
if (anxietyScore >= 5 && avoidanceScore >= 5) {
  type = '紊乱型';
} else if (anxietyScore >= 5) {
  type = '焦虑型';
} else if (avoidanceScore >= 5) {
  type = '回避型';
} else if (securityScore >= 5) {
  type = '安全型';
} else {
  // ✅ 所有得分都低于5分 → 得分不足
  type = '得分不足';
}
```

#### (3) 配置信息
```typescript
const config = ATTACHMENT_TYPE_CONFIG[type] || {
  typeLabel: '得分不足',
  description: '三个维度得分都低于5分，无法给出具体的依恋类型',
};
```

---

### 2. 后台前端调整

**文件**：`frontend-admin/src/views/members/MemberDetail.vue`

#### (1) 依恋类型展示
```vue
<!-- 检测到"得分不足"时显示警告框 -->
<a-descriptions-item label="依恋类型">
  <div v-if="assessmentResults.attachment.resultData?.type === '得分不足'">
    <a-alert 
      message="得分不足" 
      description="三个维度得分都低于5分，无法给出具体的依恋类型" 
      type="warning" 
      show-icon 
    />
  </div>
  <div v-else-if="attachmentDetailInfo">
    <!-- 正常显示类型信息 -->
  </div>
</a-descriptions-item>
```

#### (2) 三维度得分显示（关键修复）
```vue
<!-- 直接从 assessmentResults.attachment.resultData 读取得分数据 -->
<!-- 不依赖 attachmentDetailInfo，确保"得分不足"状态下也能显示 -->
<a-descriptions-item label="三维度得分详情">
  <div v-if="assessmentResults.attachment.resultData">
    <!-- 焦虑维度 -->
    <div>
      <a-tag color="orange">A</a-tag> 焦虑维度（Anxiety）
      <span>{{ assessmentResults.attachment.resultData.anxietyScore || 0 }}/12 分</span>
      <a-progress :percent="..." />
      <div>{{ getDimensionDescription('A', ...) }}</div>
    </div>
    <!-- 回避维度、安全感维度 同样处理 -->
  </div>
</a-descriptions-item>
```

**重要说明**：
- ✅ 三维度得分显示条件改为 `v-if="assessmentResults.attachment.resultData"`
- ✅ 直接读取 `resultData.anxietyScore`、`avoidanceScore`、`securityScore`
- ✅ 不再依赖 `attachmentDetailInfo`（因为"得分不足"时它为 null）
- ✅ 无论什么类型（包括"得分不足"），都能正常显示三维度得分

#### (3) 隐藏详细解释
```vue
<!-- 核心特质、典型行为表现、相处优势/痛点 -->
<!-- 添加条件: && assessmentResults.attachment.resultData?.type !== '得分不足' -->
<a-descriptions-item 
  label="核心特质" 
  v-if="attachmentDetailInfo && assessmentResults.attachment.resultData?.type !== '得分不足'"
>
  <!-- 内容 -->
</a-descriptions-item>
```

---

### 3. 前台展示调整

**文件**：`frontend-h5/src/views/assessment/AttachmentResult.vue`

#### (1) 类型卡片
```vue
<!-- 得分不足时的特殊卡片 -->
<div v-if="result.type === '得分不足'" class="type-card type-insufficient">
  <p class="intro-text">您在《幸福力婚恋关系测试》中显示是：</p>
  <div class="insufficient-notice">
    <van-icon name="info-o" size="24" color="#fa8c16" />
          <h3 class="insufficient-title">得分不足</h3>
          <p class="insufficient-desc">
            三个维度得分都低于5分，无法给出具体的依恋类型
          </p>
    <p class="insufficient-tip">
      请查看下方三维度得分详情，或联系您的专属红娘老师进行深入沟通
    </p>
  </div>
</div>

<!-- 正常类型卡片 -->
<div v-else class="type-card" :class="`type-${getTypeClass(result.type)}`">
  <!-- 类型信息 -->
</div>
```

#### (2) 样式定义
```css
.type-card.type-insufficient {
  border-top: 4px solid #fa8c16; /* 橙色边框 */
}

.insufficient-notice {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin-top: 16px;
}

.insufficient-title {
  font-size: 20px;
  font-weight: 600;
  color: #fa8c16;
}

.insufficient-desc {
  font-size: 14px;
  color: #666;
  line-height: 1.6;
  text-align: center;
}

.insufficient-tip {
  font-size: 13px;
  color: #999;
  background: #fff7e6;
  border-radius: 8px;
  padding: 12px;
}
```

---

## 判定逻辑对比

### 原逻辑（已废弃）
```typescript
// ❌ 根据相对得分判定倾向性类型
if (securityScore >= anxietyScore && securityScore >= avoidanceScore) {
  type = '安全型';
} else if (anxietyScore > avoidanceScore) {
  type = '焦虑型';
} else if (avoidanceScore > anxietyScore) {
  type = '回避型';
} else {
  type = '紊乱型';
}
```

### 新逻辑（当前）
```typescript
// ✅ 直接判定为"得分不足"
else {
  type = '得分不足';
}
```

---

## UI 展示效果

### 后台档案页面

```
┌─ 依恋关系测评结果 ────────────────────────┐
│ ┌─ 依恋类型 ─────────────────────────┐ │
│ │ ⚠️ 得分不足                        │ │
│ │ 三个维度得分都低于5分，             │ │
│ │ 无法给出具体的依恋类型             │ │
│ └────────────────────────────────────┘ │
│                                          │
│ ┌─ 三维度得分详情 ───────────────────┐ │
│ │ [A] 焦虑维度      3/12 分          │ │
│ │ ███░░░░░░░░░ 25%                   │ │
│ │ 对关系的安全感较强，不易焦虑       │ │
│ │                                     │ │
│ │ [B] 回避维度      2/12 分          │ │
│ │ ██░░░░░░░░░░ 17%                   │ │
│ │ 愿意建立情感亲密，不排斥依赖       │ │
│ │                                     │ │
│ │ [C] 安全感维度    3/12 分          │ │
│ │ ███░░░░░░░░░ 25%                   │ │
│ │ 安全感不足，需要建立信任           │ │
│ └────────────────────────────────────┘ │
│                                          │
│ (不显示核心特质、典型行为表现等)       │
└──────────────────────────────────────────┘
```

### 前台结果页面

```
┌─ 专业依恋关系测评结果 ────────────────┐
│ ┌─ 得分不足卡片 ─────────────────┐   │
│ │ 您在《幸福力婚恋关系测试》中   │   │
│ │ 显示是：                       │   │
│ │                                 │   │
│ │       ℹ️                        │   │
│ │     得分不足                   │   │
│ │                                 │   │
│ │ 三个维度得分都低于5分，        │   │
│ │ 无法给出具体的依恋类型         │   │
│ │                                 │   │
│ │ ┌─ 提示 ─────────────────────┐ │   │
│ │ │ 请查看下方三维度得分详情， │ │   │
│ │ │ 或联系您的专属红娘老师     │ │   │
│ │ │ 进行深入沟通               │ │   │
│ │ └────────────────────────────┘ │   │
│ └────────────────────────────────┘   │
│                                        │
│ ┌─ 三维度得分详情 ──────────────┐   │
│ │ (显示焦虑、回避、安全感得分) │   │
│ └────────────────────────────────┘   │
│                                        │
│ ┌─ 专业关系建议 ────────────────┐   │
│ │ 更详细的测试结果解读与改善方案│   │
│ │ 请联系您的专属红娘老师        │   │
│ └────────────────────────────────┘   │
└────────────────────────────────────────┘
```

---

## 测试验证

### 1. 后端服务
已重启后端服务，更改已生效。

### 2. 测试步骤
1. 前台完成依恋关系测试，确保三个维度得分都 < 5
2. 查看前台结果页：应显示"得分不足"提示
3. 后台查看档案：应显示警告框，但仍能看到三维度得分详情

### 3. 预期结果
- ✅ 不再显示具体的依恋类型（如"安全型"）
- ✅ 显示"得分不足"特定文案
- ✅ 三维度得分详情正常展示
- ✅ 不展示核心特质、行为表现等详细解释

---

## 心理学考量

### 为什么采用"得分不足"判定？

1. **专业性**：当用户的三个维度得分都较低时，说明其依恋特征**不够明显**，强行归类可能会导致误判。

2. **真实性**：心理学测评中，"不够典型"的情况是客观存在的，应如实反馈。

3. **咨询导向**：显示"得分不足"提示，引导用户寻求红娘老师的深入沟通，而非依赖自动化判定。

4. **数据完整性**：即使无法给出类型，仍展示三维度得分，为专业咨询提供数据参考。

---

**文档版本**: v1.0  
**创建时间**: 2026-01-15  
**编写人员**: AI Assistant  
**状态**: ✅ 功能已完成

