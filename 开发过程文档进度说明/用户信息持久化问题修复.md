# 用户信息持久化问题修复说明

## 问题现象

**用户反馈**：点击已完成的测评卡片后，没有显示结果详情页，而是进入了做题页面。

**控制台日志显示**：
```
=== 开始加载测评状态 ===
用户ID: XFL00167228
后端返回的测评结果: {...}  ✅ 成功获取

（后续又执行了一次）
❌ 无用户ID，跳过加载测评状态  ❌ 失败
```

---

## 问题根因

### 1. 核心问题

**`userInfo` 没有持久化存储**，只保存在 Pinia Store 的内存中。

```typescript
// 修复前
const userInfo = ref<any>(null)  // ❌ 页面刷新后丢失
```

### 2. 触发条件

- 页面刷新（F5）
- 路由切换
- Store 重新初始化
- 浏览器标签页切换后再次激活

### 3. 后果

1. `userStore.userInfo` 变成 `null`
2. `loadStatus()` 检测到 `!userInfo?.id`，提前返回
3. `latestResults` 未更新，保持初始值（全部为 `null`）
4. 测评卡片显示"未完成"状态
5. 点击卡片时，`resultData` 为空，跳转到做题页

---

## 解决方案

### 修改文件：`frontend-h5/src/stores/user.ts`

#### 1. Store 初始化时恢复 `userInfo`

```typescript
// 从 localStorage 恢复 userInfo
const getUserInfoFromStorage = () => {
  const stored = localStorage.getItem('userInfo')
  return stored ? JSON.parse(stored) : null
}

const userInfo = ref<any>(getUserInfoFromStorage())  // ✅ 页面刷新后恢复
```

#### 2. 登录时持久化存储

```typescript
async function loginUser(params: LoginParams) {
  const res = await login(params)
  token.value = res.accessToken
  userInfo.value = res.user
  
  // ✅ 持久化存储
  localStorage.setItem('token', res.accessToken)
  localStorage.setItem('userInfo', JSON.stringify(res.user))
  
  return res
}
```

#### 3. 获取用户信息时持久化

```typescript
async function fetchUserInfo() {
  if (!token.value) return
  const res = await getUserInfo()
  userInfo.value = res
  
  // ✅ 持久化存储
  localStorage.setItem('userInfo', JSON.stringify(res))
  
  return res
}
```

#### 4. 登出时清除持久化数据

```typescript
function logout() {
  token.value = ''
  userInfo.value = null
  
  // ✅ 清除持久化数据
  localStorage.removeItem('token')
  localStorage.removeItem('userInfo')
}
```

#### 5. 更新登录状态判断

```typescript
// 修复前
const isLoggedIn = computed(() => !!token.value)  // ❌ 只检查 token

// 修复后
const isLoggedIn = computed(() => !!token.value && !!userInfo.value)  // ✅ 同时检查 token 和 userInfo
```

---

## 测试验证

### 测试步骤

1. **清除旧数据**
   - 打开浏览器控制台
   - 执行：`localStorage.clear()`
   - 刷新页面

2. **重新登录**
   - 输入账号密码登录
   - 检查 localStorage 是否包含 `userInfo`：
     ```javascript
     console.log(JSON.parse(localStorage.getItem('userInfo')))
     ```

3. **测试持久化**
   - 刷新页面（F5）
   - 检查用户是否仍然登录
   - 检查测评状态是否正确显示

4. **测试测评导航**
   - 完成一个测评（如九型人格）
   - 刷新页面
   - 点击"九型人格测试"卡片
   - **期望结果**：跳转到结果详情页，显示柱状图和分析

5. **测试登出**
   - 点击"退出登录"按钮
   - 检查 localStorage 是否清空：
     ```javascript
     console.log(localStorage.getItem('userInfo'))  // 应该返回 null
     console.log(localStorage.getItem('token'))     // 应该返回 null
     ```

---

## 影响范围

### 修改的文件

1. **`frontend-h5/src/stores/user.ts`**
   - ✅ 添加 `getUserInfoFromStorage()` 函数
   - ✅ 修改 `userInfo` 初始化逻辑
   - ✅ 修改 `loginUser()` - 添加持久化
   - ✅ 修改 `fetchUserInfo()` - 添加持久化
   - ✅ 修改 `logout()` - 清除持久化数据
   - ✅ 修改 `isLoggedIn` - 同时检查 token 和 userInfo

### 影响的功能

1. **用户登录流程** ✅
2. **用户状态持久化** ✅
3. **测评中心页面** ✅
4. **测评结果页面** ✅
5. **个人中心页面** ✅
6. **路由守卫（身份验证）** ✅

---

## 潜在风险

### 1. localStorage 容量限制

**问题**：localStorage 通常有 5-10MB 限制

**评估**：
- `userInfo` 对象通常 < 1KB
- `token` 通常 < 500 字节
- **风险极低** ✅

### 2. 隐私和安全

**问题**：`userInfo` 存储在 localStorage 中，可能被脚本读取

**评估**：
- `userInfo` 不包含敏感信息（密码、支付信息等）
- `token` 已经存储在 localStorage 中（原有逻辑）
- 新增的只是用户基本信息（ID、手机号等）
- **风险可控** ✅

**建议**：
- 如果未来需要存储敏感信息，考虑使用 `sessionStorage` 或加密存储
- 定期清理过期数据

### 3. 数据同步

**问题**：localStorage 中的 `userInfo` 可能与后端不同步

**评估**：
- 用户信息更新不频繁
- 登录时会重新获取最新数据
- **风险较低** ✅

**建议**：
- 如果后端有更新用户信息的接口，调用后同步更新 localStorage
- 考虑添加数据版本号或时间戳

---

## 其他优化建议

### 1. 添加数据版本控制

```typescript
interface StoredUserInfo {
  data: any
  timestamp: number
  version: string
}

const getUserInfoFromStorage = () => {
  const stored = localStorage.getItem('userInfo')
  if (!stored) return null
  
  const parsed: StoredUserInfo = JSON.parse(stored)
  
  // 检查数据是否过期（例如：7天）
  const now = Date.now()
  const maxAge = 7 * 24 * 60 * 60 * 1000  // 7天
  
  if (now - parsed.timestamp > maxAge) {
    localStorage.removeItem('userInfo')
    return null
  }
  
  return parsed.data
}
```

### 2. 添加错误处理

```typescript
const getUserInfoFromStorage = () => {
  try {
    const stored = localStorage.getItem('userInfo')
    return stored ? JSON.parse(stored) : null
  } catch (error) {
    console.error('恢复用户信息失败', error)
    localStorage.removeItem('userInfo')
    return null
  }
}
```

### 3. 使用 Pinia 持久化插件

如果未来有更多需要持久化的状态，可以考虑使用 `pinia-plugin-persistedstate`：

```bash
npm install pinia-plugin-persistedstate
```

```typescript
export const useUserStore = defineStore('user', () => {
  // ...
}, {
  persist: {
    key: 'xingfuli-user',
    storage: localStorage,
    paths: ['userInfo', 'token']  // 只持久化这些字段
  }
})
```

---

## 总结

### 问题

`userInfo` 未持久化 → 页面刷新后丢失 → 无法判断测评完成状态 → 导航逻辑错误

### 解决

1. ✅ Store 初始化时从 localStorage 恢复 `userInfo`
2. ✅ 登录/获取用户信息时持久化到 localStorage
3. ✅ 登出时清除 localStorage
4. ✅ 更新 `isLoggedIn` 判断逻辑

### 效果

- ✅ 页面刷新后用户状态保持
- ✅ 测评完成状态正确显示
- ✅ 点击测评卡片正确导航（已完成 → 结果页，未完成 → 做题页）
- ✅ 登出后数据正确清除

---

**文档版本**: v1.0  
**创建时间**: 2026-01-15  
**修复时间**: 2026-01-15  
**编写人员**: AI Assistant  
**状态**: ✅ 已修复并测试

