# 第二阶段开发计划：心理测评系统

**开始时间**：2026-01-12  
**预期目标**：完成三大测评引擎（九型人格、依恋关系、婚恋幸福力）

---

## 📋 开发任务清单

### 阶段 1：数据库与基础数据 ✅

#### 1.1 数据库表创建 ✅
- [x] `assessment_question` - 测评题库表
- [x] `enneagram_config` - 九型人格配置表
- [x] `enneagram_match_matrix` - 九型人格匹配矩阵
- [x] `attachment_config` - 依恋类型配置表
- [x] `happiness_dimension` - 幸福力维度配置表
- [x] `assessment_record` - 测评记录表（完善版）

**执行脚本**：`database/04_assessment_tables.sql`

#### 1.2 题库数据准备 ⏳
- [ ] 九型人格题库录入（需要准备完整题目）
- [ ] 依恋关系题库录入（焦虑、回避、安全三组题目）
- [ ] 婚恋幸福力题库录入（20个维度的题目）
- [ ] 九型人格匹配矩阵数据（9x9，81条记录）

**优先级**：🔴 高（需要提前准备题库数据）

---

### 阶段 2：后端 API 开发

#### 2.1 测评模块 API
- [ ] `GET /api/v1/assessments/:type/questions` - 获取题库
- [ ] `POST /api/v1/assessments/:type/submit` - 提交答卷并计算结果
- [ ] `GET /api/v1/assessments/:type/result/:id` - 获取测评结果
- [ ] `GET /api/v1/assessments/:type/history` - 获取历史记录

#### 2.2 算法实现
**九型人格**：
- [ ] 得分统计算法
- [ ] Top3 筛选逻辑
- [ ] 15% 阈值判定
- [ ] 百分比计算

**依恋关系**：
- [ ] ABC 三分值计算
- [ ] 四种类型判定优先级（紊乱 > 焦虑 > 回避 > 安全）

**婚恋幸福力**：
- [ ] 20个维度独立计分
- [ ] 百分比转换（0-10分制）

#### 2.3 配置接口
- [ ] `GET /api/v1/assessments/enneagram/config` - 九型人格配置
- [ ] `GET /api/v1/assessments/attachment/config` - 依恋类型配置
- [ ] `GET /api/v1/assessments/happiness/dimensions` - 幸福力维度配置

---

### 阶段 3：前端 H5 开发

#### 3.1 页面结构
- [ ] **测评中心页** (`/assessment`)
  - 三大测评入口卡片
  - 测评状态显示（已完成/未完成）
  - 跳转到答题页

- [ ] **答题页** (`/assessment/:type/test`)
  - 单题展示
  - 进度条
  - 上一题/下一题按钮
  - 答案缓存（防止误操作）
  - 提交确认弹窗

- [ ] **结果页** (`/assessment/:type/result/:id`)
  - **九型人格**：柱状图 + 文案描述
  - **依恋关系**：类型标签 + 特质描述
  - **婚恋幸福力**：双层圆环图（20个扇形）

#### 3.2 组件开发
- [ ] 测评进度条组件
- [ ] 选项卡片组件（单选/多选）
- [ ] 柱状图组件（九型人格）
- [ ] 圆环图组件（婚恋幸福力）- **重点**

#### 3.3 个人中心增强
- [ ] 在个人中心显示测评历史
- [ ] 支持重新测试

---

### 阶段 4：后台管理端开发

#### 4.1 用户档案增强
- [ ] 在用户详情页展示测评结果（只读）
- [ ] 测评结果可视化展示（复用前台组件）

#### 4.2 扩展字段编辑（为 MV 计算准备）
- [ ] 长相评分字段
- [ ] 收入字段
- [ ] 房车情况字段
- [ ] 家庭背景字段
- [ ] 其他自定义字段

#### 4.3 题库管理（可选，低优先级）
- [ ] 题库列表查看
- [ ] 题库编辑功能

---

## 🎯 开发优先级

### 第一批（核心流程）
1. ✅ 数据库表创建
2. ⏳ 题库数据准备（**关键路径**）
3. 后端：获取题库 API
4. 后端：提交答卷 + 计算算法
5. 前端：答题页
6. 前端：结果页（基础版）

### 第二批（优化增强）
7. 前端：测评中心页
8. 前端：结果页可视化（图表组件）
9. 后台：档案中展示测评结果
10. 历史记录功能

### 第三批（非核心）
11. 重测功能
12. 题库管理后台

---

## 📊 技术难点与解决方案

### 难点 1：婚恋幸福力圆环图
**需求**：20个扇形切片，每个切片分5等份，根据得分动态填充颜色

**方案**：
- 使用 Canvas 或 SVG 绘制
- 或使用 ECharts/D3.js 图表库定制
- 建议：先用 ECharts 快速实现，后续优化

### 难点 2：九型人格 Top3 筛选算法
**逻辑**：
1. 计算每个人格的百分比
2. 取最高的3个
3. 过滤低于 `(最高分 - 15%)` 的结果
4. 至少保留3个（即使低于阈值）

### 难点 3：依恋关系优先级判定
**逻辑**：
```
if (A >= 5 && B >= 5) return '紊乱型'
else if (A >= 5) return '焦虑型'
else if (B >= 5) return '回避型'
else if (C >= 5) return '安全型'
else return '未明确分类'（边界情况）
```

---

## 📝 数据准备需求

### 题库数据格式（JSON）

#### 九型人格题目示例
```json
{
  "type": 1,
  "question_no": 1,
  "content": "在团队中，我更倾向于？",
  "options": [
    {
      "text": "确保每个细节都完美执行",
      "scores": {"1": 2, "6": 1}  // 选择后给1号人格加2分，6号人格加1分
    },
    {
      "text": "关注团队成员的感受",
      "scores": {"2": 2, "9": 1}
    }
  ]
}
```

#### 依恋关系题目示例
```json
{
  "type": 2,
  "question_no": 1,
  "sub_type": "anxiety",
  "content": "在亲密关系中，我经常担心对方不够爱我",
  "options": [
    {"text": "非常不符合", "score": 0},
    {"text": "不太符合", "score": 1},
    {"text": "有点符合", "score": 2},
    {"text": "非常符合", "score": 3}
  ]
}
```

#### 幸福力题目示例
```json
{
  "type": 3,
  "question_no": 1,
  "dimension_id": 1,  // 对应"积极性格"维度
  "content": "面对困难时，我通常能保持乐观",
  "options": [
    {"text": "完全不符合", "score": 0},
    {"text": "较不符合", "score": 1},
    {"text": "不确定", "score": 2},
    {"text": "较符合", "score": 3},
    {"text": "完全符合", "score": 4}
  ]
}
```

---

## ✅ 第一步行动：执行数据库脚本

```bash
# 进入数据库目录
cd database

# 执行脚本
mysql -u root -p < 04_assessment_tables.sql

# 确认表创建成功
mysql -u root -p -e "USE xingfuli; SHOW TABLES LIKE 'assessment%'; SHOW TABLES LIKE '%config%';"
```

---

## 🔄 下一步

**立即行动**：
1. ✅ 执行数据库脚本
2. 准备题库数据（或使用测试数据先进行开发）
3. 开始后端 API 开发

**需要确认**：
- 是否已有完整的题库数据？
- 如果没有，是否先用少量测试数据进行开发？
- 前端图表库选择：ECharts 还是自定义？

