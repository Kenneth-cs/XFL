# 门店表结构修复说明

## 问题原因

1. **404错误**：MV方案接口路由顺序错误，被`:id`路由拦截
2. **500错误**：数据库表结构未更新，缺少新增的字段

---

## 解决方案

### 步骤1：修复路由顺序（已完成）

已将 `GET /stores/mv-templates/list` 接口移到 `GET /stores/:id` 之前，避免路由冲突。

### 步骤2：更新数据库表结构（需手动执行）

请在 **DataGrip** 中执行以下SQL语句：

```sql
USE xingfuli;

-- 删除旧字段
ALTER TABLE `sys_store` DROP COLUMN IF EXISTS `region_info`;

-- 添加新字段
ALTER TABLE `sys_store` 
  ADD COLUMN IF NOT EXISTS `business_license_name` VARCHAR(200) NULL COMMENT '营业执照名称' AFTER `mv_template_id`,
  ADD COLUMN IF NOT EXISTS `credit_code` VARCHAR(50) NULL COMMENT '统一社会信用代码' AFTER `business_license_name`,
  ADD COLUMN IF NOT EXISTS `province` VARCHAR(50) NULL COMMENT '省份' AFTER `credit_code`,
  ADD COLUMN IF NOT EXISTS `city` VARCHAR(50) NULL COMMENT '市' AFTER `province`,
  ADD COLUMN IF NOT EXISTS `district` VARCHAR(50) NULL COMMENT '区' AFTER `city`,
  ADD COLUMN IF NOT EXISTS `address` VARCHAR(200) NULL COMMENT '详细地址' AFTER `district`;

-- 调整现有字段位置
ALTER TABLE `sys_store` 
  MODIFY COLUMN `contact_person` VARCHAR(50) NULL COMMENT '联系人' AFTER `address`,
  MODIFY COLUMN `contact_phone` VARCHAR(20) NULL COMMENT '联系方式' AFTER `contact_person`;

-- 添加合同相关字段
ALTER TABLE `sys_store` 
  ADD COLUMN IF NOT EXISTS `contract_number` VARCHAR(100) NULL COMMENT '合同号' AFTER `contact_phone`,
  ADD COLUMN IF NOT EXISTS `contract_start_date` DATE NULL COMMENT '签约时间' AFTER `contract_number`,
  ADD COLUMN IF NOT EXISTS `contract_end_date` DATE NULL COMMENT '到期时间' AFTER `contract_start_date`;

-- 添加索引
ALTER TABLE `sys_store` 
  ADD INDEX IF NOT EXISTS `idx_credit_code` (`credit_code`),
  ADD INDEX IF NOT EXISTS `idx_province_city` (`province`, `city`);

-- 验证表结构
DESC sys_store;
```

### 步骤3：重启后端服务

执行完SQL后，重启后端服务使修改生效：

```bash
# 停止当前后端服务（Ctrl+C）
# 然后重新启动
cd /Users/cs/Desktop/CS/创业/相亲项目开发/幸福力项目开发/backend
npm run start:dev
```

### 步骤4：刷新前端页面

重启后端后，刷新浏览器页面（Ctrl+R 或 Cmd+R）

---

## 验证步骤

### 1. 验证MV方案接口

在浏览器中访问：
```
http://localhost:3000/api/v1/stores/mv-templates/list
```

**预期结果**：返回5套MV方案的JSON数据：
```json
[
  {
    "id": 1,
    "code": "GUANGDONG",
    "name": "婚恋价值广东周边地区",
    "description": "适用于广东及周边地区",
    "region": "广东、广西、福建等"
  },
  {
    "id": 2,
    "code": "JIANGZHE",
    "name": "婚恋价值江浙周边地区",
    "description": "适用于江浙及周边地区",
    "region": "江苏、浙江、安徽等"
  },
  ...
]
```

### 2. 验证门店列表接口

在浏览器中访问：
```
http://localhost:3000/api/v1/stores
```

**预期结果**：返回门店列表（可能为空数组 `[]`）

### 3. 验证前端页面

1. 访问后台管理系统：`http://localhost:5175`
2. 登录超级管理员账号（super_admin / admin654321）
3. 导航到"系统管理" → "门店列表"
4. 点击"新增门店"按钮
5. **验证MV方案下拉框显示5个选项**：
   - 婚恋价值广东周边地区
   - 婚恋价值江浙周边地区
   - 婚恋价值全国普适版
   - 婚恋价值上海北京地区
   - 婚恋价值东北新疆地区
6. **验证表单包含所有字段**：
   - 门店名称
   - MV计算方案
   - 营业执照名称
   - 统一社会信用代码
   - 省份、市、区
   - 详细地址
   - 联系人、联系方式
   - 合同号
   - 签约时间、到期时间

---

## 常见问题

### Q1: 执行SQL时提示 "Duplicate column name"

**原因**：字段已存在

**解决**：SQL语句中使用了 `IF NOT EXISTS`，可以忽略此警告，或者单独执行缺少的字段。

### Q2: 后端仍然报500错误

**原因**：后端服务未重启，仍在使用旧的表结构

**解决**：强制停止后端服务（Ctrl+C），然后重新启动：
```bash
cd /Users/cs/Desktop/CS/创业/相亲项目开发/幸福力项目开发/backend
npm run start:dev
```

### Q3: MV方案下拉框仍然显示"No data"

**可能原因**：
1. 后端服务未重启
2. 前端缓存未清除
3. 路由修复未生效

**解决步骤**：
1. 确认后端服务已重启
2. 清除浏览器缓存并刷新（Ctrl+Shift+R 或 Cmd+Shift+R）
3. 检查浏览器控制台，确认 `/api/v1/stores/mv-templates/list` 接口返回200状态码

---

## 完整的表结构（更新后）

```sql
CREATE TABLE `sys_store` (
  `id` char(6) NOT NULL COMMENT '门店ID (如: XFL001)',
  `name` varchar(100) NOT NULL COMMENT '门店名称',
  `mv_template_id` tinyint NOT NULL COMMENT 'MV地域方案ID (1:广东周边, 2:江浙周边, 3:全国普适, 4:京沪, 5:东北新疆)',
  `business_license_name` varchar(200) DEFAULT NULL COMMENT '营业执照名称',
  `credit_code` varchar(50) DEFAULT NULL COMMENT '统一社会信用代码',
  `province` varchar(50) DEFAULT NULL COMMENT '省份',
  `city` varchar(50) DEFAULT NULL COMMENT '市',
  `district` varchar(50) DEFAULT NULL COMMENT '区',
  `address` varchar(200) DEFAULT NULL COMMENT '详细地址',
  `contact_person` varchar(50) DEFAULT NULL COMMENT '联系人',
  `contact_phone` varchar(20) DEFAULT NULL COMMENT '联系方式',
  `contract_number` varchar(100) DEFAULT NULL COMMENT '合同号',
  `contract_start_date` date DEFAULT NULL COMMENT '签约时间',
  `contract_end_date` date DEFAULT NULL COMMENT '到期时间',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态: 1-正常, 0-禁用, -1-已删除(软删除)',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  KEY `idx_credit_code` (`credit_code`),
  KEY `idx_province_city` (`province`,`city`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='门店表';
```

