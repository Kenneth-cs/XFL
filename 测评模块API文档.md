# å¹¸ç¦åŠ›æµ‹è¯„æ¨¡å— API æ–‡æ¡£

## ğŸ“¦ æ¨¡å—ç»“æ„

```
backend/src/modules/assessment/
â”œâ”€â”€ assessment.module.ts              # æ¨¡å—å®šä¹‰
â”œâ”€â”€ assessment.controller.ts          # APIæ§åˆ¶å™¨
â”œâ”€â”€ assessment.service.ts             # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ submit-enneagram.dto.ts      # ä¹å‹äººæ ¼æäº¤DTO
â”‚   â”œâ”€â”€ submit-attachment.dto.ts     # ä¾æ‹å…³ç³»æäº¤DTO
â”‚   â””â”€â”€ submit-happiness.dto.ts      # å¹¸ç¦åŠ›æäº¤DTO
â””â”€â”€ calculators/
    â”œâ”€â”€ enneagram.calculator.ts      # ä¹å‹äººæ ¼è®¡ç®—å™¨
    â”œâ”€â”€ attachment.calculator.ts     # ä¾æ‹å…³ç³»è®¡ç®—å™¨
    â””â”€â”€ happiness.calculator.ts      # å¹¸ç¦åŠ›è®¡ç®—å™¨
```

---

## ğŸŒ API æ¥å£åˆ—è¡¨

### åŸºç¡€è·¯å¾„
æ‰€æœ‰æ¥å£ç»Ÿä¸€å‰ç¼€ï¼š`/api/v1/assessments`

---

## 1. ä¹å‹äººæ ¼æµ‹è¯„

### 1.1 è·å–é¢˜ç›®
**è¯·æ±‚**
```http
GET /api/v1/assessments/enneagram/questions
Authorization: Bearer <token>
```

**å“åº”**
```json
{
  "total": 144,
  "questions": [
    {
      "questionId": 1,
      "content": "ä»¥ä¸‹ä¸¤ä¸ªé€‰é¡¹æˆ‘æ¯”è¾ƒå€¾å‘äº",
      "options": [
        { "text": "æˆ‘æµªæ¼«å¹¶å¯Œäºå¹»æƒ³", "type": 5 },
        { "text": "æˆ‘å¾ˆå®é™…å¹¶å®äº‹æ±‚æ˜¯", "type": 2 }
      ]
    }
  ]
}
```

### 1.2 æäº¤æµ‹è¯„
**è¯·æ±‚**
```http
POST /api/v1/assessments/enneagram/submit
Authorization: Bearer <token>
Content-Type: application/json

{
  "userId": "XFL00100001",
  "answers": [
    { "questionId": 1, "selectedType": 5 },
    { "questionId": 2, "selectedType": 1 },
    ...
  ]
}
```

**å“åº”**
```json
{
  "recordId": 123,
  "result": {
    "top3": [5, 2, 4],
    "percentages": {
      "1": 0.45,
      "2": 0.78,
      "3": 0.52,
      "4": 0.72,
      "5": 0.85,
      ...
    },
    "rawScores": {
      "1": 12,
      "2": 20,
      ...
    },
    "primaryType": 5
  }
}
```

**è®¡ç®—é€»è¾‘**ï¼š
1. ç»Ÿè®¡æ¯ä¸ªäººæ ¼ç±»å‹ï¼ˆ1-9å·ï¼‰çš„å®é™…å¾—åˆ†
2. è®¡ç®—ç™¾åˆ†æ¯” = å®é™…å¾—åˆ† / æ ‡å‡†æ»¡åˆ†
3. æŒ‰ç™¾åˆ†æ¯”é™åºæ’åºï¼Œè·å– Top 3
4. æœ‰æ•ˆé˜ˆå€¼ç­›é€‰ï¼š`(æœ€é«˜åˆ† - 15%)` ä½œä¸ºé˜ˆå€¼ï¼Œè‡³å°‘ä¿ç•™3ä¸ª

---

## 2. ä¾æ‹å…³ç³»æµ‹è¯„

### 2.1 è·å–é¢˜ç›®
**è¯·æ±‚**
```http
GET /api/v1/assessments/attachment/questions
Authorization: Bearer <token>
```

**å“åº”**
```json
{
  "total": 36,
  "questions": [
    {
      "questionId": "A1",
      "content": "åœ¨æ‹çˆ±ä¸­ç‰¹åˆ«æ¸´æœ›äº²å¯†",
      "dimension": "A"
    },
    {
      "questionId": "B1",
      "content": "é‡è§†è‡ªæˆ‘ç‹¬ç«‹ï¼Œä¸æ„¿æ„è¿‡åº¦æŠ•å…¥æ„Ÿæƒ…",
      "dimension": "B"
    },
    {
      "questionId": "C1",
      "content": "è¨€è¡Œä¸€è‡´ï¼Œå€¼å¾—ä¿¡èµ–",
      "dimension": "C"
    }
  ]
}
```

### 2.2 æäº¤æµ‹è¯„
**è¯·æ±‚**
```http
POST /api/v1/assessments/attachment/submit
Authorization: Bearer <token>
Content-Type: application/json

{
  "userId": "XFL00100001",
  "selectedQuestions": ["A1", "A5", "B3", "C10"]
}
```

**å“åº”**
```json
{
  "recordId": 124,
  "result": {
    "anxietyScore": 2,
    "avoidanceScore": 1,
    "securityScore": 1,
    "type": "å¾…è¿›ä¸€æ­¥æ²Ÿé€š",
    "typeLabel": "å¾…è¯„ä¼°",
    "description": "æœªè¾¾åˆ°ä»»ä½•ç±»å‹åˆ¤å®šé˜ˆå€¼ï¼Œè¯·è”ç³»çº¢å¨˜è€å¸ˆè¿›è¡Œè¿›ä¸€æ­¥æ²Ÿé€š"
  }
}
```

**è®¡ç®—é€»è¾‘**ï¼š
- ç„¦è™‘å¾—åˆ†ï¼ˆAï¼‰= é€‰ä¸­Aå¼€å¤´é¢˜ç›®çš„æ•°é‡
- å›é¿å¾—åˆ†ï¼ˆBï¼‰= é€‰ä¸­Bå¼€å¤´é¢˜ç›®çš„æ•°é‡
- å®‰å…¨æ„Ÿå¾—åˆ†ï¼ˆCï¼‰= é€‰ä¸­Cå¼€å¤´é¢˜ç›®çš„æ•°é‡
- åˆ¤å®šä¼˜å…ˆçº§ï¼šç´Šä¹±å‹ (Aâ‰¥5 & Bâ‰¥5) > ç„¦è™‘å‹ (Aâ‰¥5) > å›é¿å‹ (Bâ‰¥5) > å®‰å…¨å‹ (Câ‰¥5)

---

## 3. å©šæ‹å¹¸ç¦åŠ›æµ‹è¯„

### 3.1 è·å–é¢˜ç›®
**è¯·æ±‚**
```http
GET /api/v1/assessments/happiness/questions
Authorization: Bearer <token>
```

**å“åº”**
```json
{
  "total": 155,
  "questions": [
    {
      "questionId": "D1-Q1",
      "dimensionId": 1,
      "subLabel": "åˆ›é€ åŠ›",
      "content": "æˆ‘å–œæ¬¢å°è¯•æ–°æ–¹æ³•æ¥è§£å†³é—®é¢˜",
      "options": [
        { "value": 1, "label": "éå¸¸ä¸ç¬¦åˆ" },
        { "value": 2, "label": "ä¸å¤ªç¬¦åˆ" },
        { "value": 3, "label": "ä¸€èˆ¬" },
        { "value": 4, "label": "æ¯”è¾ƒç¬¦åˆ" },
        { "value": 5, "label": "éå¸¸ç¬¦åˆ" }
      ],
      "isIgnored": false
    }
  ]
}
```

### 3.2 æäº¤æµ‹è¯„
**è¯·æ±‚**
```http
POST /api/v1/assessments/happiness/submit
Authorization: Bearer <token>
Content-Type: application/json

{
  "userId": "XFL00100001",
  "answers": [
    { "questionId": "D1-Q1", "score": 4 },
    { "questionId": "D1-Q2", "score": 5 },
    ...
  ]
}
```

**å“åº”**
```json
{
  "recordId": 125,
  "result": {
    "dimensions": [
      {
        "dimensionId": 1,
        "dimensionName": "ç§¯ææ€§æ ¼",
        "shortName": "ä¹å•†",
        "rawScore": 90,
        "maxScore": 120,
        "targetScore": 10,
        "normalizedScore": 7.5,
        "percentage": 0.75
      },
      ...
    ],
    "averageScore": 7.25,
    "totalRawScore": 850,
    "totalMaxScore": 1200
  }
}
```

**è®¡ç®—é€»è¾‘**ï¼š
1. **ç»Ÿä¸€è®¡åˆ†è§„åˆ™**ï¼šæ‰€æœ‰é¢˜ç›®é€‰é¡¹valueç›´æ¥è®¡åˆ†ï¼ˆ1-5åˆ†å¯¹åº”1-5åˆ†ï¼‰ï¼Œæ— åå‘è®¡åˆ†
2. æŒ‰ç»´åº¦åˆ†ç»„ç»Ÿè®¡åŸå§‹å¾—åˆ†
3. å½’ä¸€åŒ–å¾—åˆ† = (åŸå§‹å¾—åˆ† / æœ€é«˜åˆ†) Ã— ç›®æ ‡åˆ†ï¼ˆé€šå¸¸10åˆ†ï¼‰
4. ç™¾åˆ†æ¯” = åŸå§‹å¾—åˆ† / æœ€é«˜åˆ†
5. å¹³å‡åˆ† = æ‰€æœ‰ç»´åº¦å½’ä¸€åŒ–å¾—åˆ†çš„å¹³å‡å€¼

**20ä¸ªç»´åº¦**ï¼š
1. ç§¯ææ€§æ ¼ï¼ˆä¹å•†ï¼‰- 24é¢˜
2. ç§¯ææƒ…ç»ªï¼ˆæƒ…å•†ï¼‰- 4é¢˜
3. ç§¯æå¿ƒæ€ï¼ˆå¿ƒå•†ï¼‰- 3é¢˜
4. ç§¯æåŠ›é‡ï¼ˆæ–½å®¹ï¼‰- 4é¢˜
5. ç§¯æè¯­è¨€ï¼ˆè¯­å•†ï¼‰- 3é¢˜
6. ç§¯ææ²Ÿé€šï¼ˆæ–½è¯­ï¼‰- 3é¢˜
7. ç§¯ææ•™è‚²ï¼ˆç´ è´¨ï¼‰- 5é¢˜
8. ç§¯ææ•™å…»ï¼ˆç®¡æ•™ï¼‰- 5é¢˜
9. ç§¯æä¹ æƒ¯ï¼ˆè‡ªå¾‹ï¼‰- 5é¢˜
10. ç§¯æå¤©èµ‹ï¼ˆä¼˜åŠ¿ï¼‰- 2é¢˜
11. ç§¯æè‡ªå°Šï¼ˆä¿®å…»ï¼‰- 10é¢˜
12. ç§¯æå…³ç³»ï¼ˆçˆ±å•†ï¼‰- 23é¢˜
13. ç§¯ææ”¹å˜ï¼ˆå‹‡æ°”ï¼‰- 5é¢˜
14. ç§¯æä¿¡å¿µï¼ˆå¸Œæœ›ï¼‰- 12é¢˜ï¼ˆå«4é¢˜å¹²æ‰°é¢˜ä¸è®¡åˆ†ï¼‰
15. ç§¯æä½“éªŒï¼ˆç¦æµï¼‰- 9é¢˜
16. ç§¯æå“è´¨ï¼ˆç¦å•†ï¼‰- 10é¢˜
17. ç§¯ææŠ•å…¥ï¼ˆå¿—å•†ï¼‰- 3é¢˜
18. ç§¯æè‡ªæˆ‘ï¼ˆå¾·å•†ï¼‰- 10é¢˜
19. ç§¯æç›®æ ‡ï¼ˆè´¢å•†ï¼‰- 4é¢˜
20. ç§¯ææ„ä¹‰ï¼ˆå¥å•†ï¼‰- 12é¢˜

---

## 4. æµ‹è¯„å†å²æŸ¥è¯¢

### 4.1 è·å–ç”¨æˆ·æµ‹è¯„å†å²
**è¯·æ±‚**
```http
GET /api/v1/assessments/history/:userId
Authorization: Bearer <token>
```

**å“åº”**
```json
[
  {
    "id": 125,
    "type": 3,
    "typeName": "å©šæ‹å¹¸ç¦åŠ›",
    "isLatest": true,
    "createdAt": "2026-01-12T08:30:00.000Z",
    "resultData": { ... }
  },
  {
    "id": 124,
    "type": 2,
    "typeName": "ä¾æ‹å…³ç³»",
    "isLatest": true,
    "createdAt": "2026-01-12T08:00:00.000Z",
    "resultData": { ... }
  }
]
```

### 4.2 è·å–ç”¨æˆ·æœ€æ–°æµ‹è¯„ç»“æœ
**è¯·æ±‚**
```http
GET /api/v1/assessments/latest/:userId
Authorization: Bearer <token>
```

**å“åº”**
```json
{
  "enneagram": {
    "recordId": 123,
    "result": { ... },
    "createdAt": "2026-01-11T10:00:00.000Z"
  },
  "attachment": {
    "recordId": 124,
    "result": { ... },
    "createdAt": "2026-01-12T08:00:00.000Z"
  },
  "happiness": {
    "recordId": 125,
    "result": { ... },
    "createdAt": "2026-01-12T08:30:00.000Z"
  }
}
```

---

## ğŸ”’ è®¤è¯è¯´æ˜

æ‰€æœ‰æ¥å£å‡éœ€è¦æºå¸¦JWT Tokenï¼š
```http
Authorization: Bearer <your_jwt_token>
```

---

## ğŸ“Š æ•°æ®åº“å­˜å‚¨

### `assessment_record` è¡¨ç»“æ„
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | BIGINT | ä¸»é”® |
| user_id | VARCHAR(20) | ç”¨æˆ·ID |
| type | TINYINT | 1:ä¹å‹, 2:ä¾æ‹, 3:å¹¸ç¦åŠ› |
| answers | JSON | åŸå§‹ç­”å·æ•°æ® |
| result_data | JSON | ç»“æ„åŒ–ç»“æœ |
| raw_scores | JSON | åŸå§‹åˆ†æ•°ï¼ˆè°ƒè¯•ç”¨ï¼‰ |
| is_latest | TINYINT | 1:æœ€æ–°, 0:å†å² |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### âœ… å·²å®ç°
1. **é¢˜åº“ä»£ç åŒ–**ï¼šæ‰€æœ‰é¢˜ç›®å­˜å‚¨åœ¨TypeScriptå¸¸é‡ä¸­ï¼Œé›¶æ•°æ®åº“æŸ¥è¯¢
2. **å‰åç«¯åˆ†ç¦»**ï¼šé¢˜ç›®å†…å®¹æš´éœ²å‰ç«¯ï¼Œè®¡ç®—é€»è¾‘ä¿æŠ¤åç«¯
3. **ç»Ÿä¸€è®¡åˆ†è§„åˆ™**ï¼šå¹¸ç¦åŠ›æµ‹è¯„æ— åå‘è®¡åˆ†ï¼Œç›´æ¥æŒ‰é€‰é¡¹valueè®¡åˆ†
4. **ç»“æœæŒä¹…åŒ–**ï¼šæ‰€æœ‰æµ‹è¯„ç»“æœå­˜å…¥æ•°æ®åº“ï¼Œæ”¯æŒå†å²æŸ¥è¯¢
5. **ç‰ˆæœ¬æ§åˆ¶**ï¼šè‡ªåŠ¨æ ‡è®°æœ€æ–°è®°å½•ï¼Œæ—§è®°å½•ä¿ç•™ä¸ºå†å²

### ğŸ” å®‰å…¨æ€§
- é¢˜ç›®å†…å®¹ï¼šå‰ç«¯å¯è§ï¼ˆç”¨æˆ·éœ€è¦çœ‹åˆ°é¢˜ç›®ï¼‰
- è®¡ç®—é€»è¾‘ï¼šä¸¥æ ¼ä¿æŠ¤åœ¨åç«¯ï¼ˆæ ¸å¿ƒç«äº‰åŠ›ï¼‰
- åŒ¹é…ç®—æ³•ï¼šå®Œå…¨åç«¯å®ç°ï¼ˆä¸æš´éœ²ä»»ä½•è§„åˆ™ï¼‰

---

## ğŸ“ å¼€å‘è§„èŒƒ

### TypeScriptæ¥å£å®šä¹‰
- æ‰€æœ‰æ¥å£å‡æœ‰ç±»å‹å®šä¹‰
- ä½¿ç”¨`class-validator`è¿›è¡Œå‚æ•°æ ¡éªŒ
- ä½¿ç”¨`class-transformer`è¿›è¡Œç±»å‹è½¬æ¢

### æ—¥å¿—è®°å½•
- å…³é”®æ“ä½œè‡ªåŠ¨è®°å½•æ—¥å¿—
- åŒ…å«ç”¨æˆ·IDã€æ“ä½œç±»å‹ã€ç»“æœæ‘˜è¦

### é”™è¯¯å¤„ç†
- ç»Ÿä¸€ä½¿ç”¨NestJSå†…ç½®å¼‚å¸¸
- å‰ç«¯å¯è·å¾—æ¸…æ™°çš„é”™è¯¯æç¤º

---

## ğŸš€ åç»­æ‰©å±•

### å¯é€‰åŠŸèƒ½
1. **æµ‹è¯„æŠ¥å‘Šç”Ÿæˆ**ï¼šæ ¹æ®ç»“æœç”ŸæˆPDFæŠ¥å‘Š
2. **æ•°æ®ç»Ÿè®¡åˆ†æ**ï¼šé—¨åº—ç»´åº¦çš„æµ‹è¯„æ•°æ®ç»Ÿè®¡
3. **ç»“æœå¯¹æ¯”**ï¼šåŒä¸€ç”¨æˆ·å¤šæ¬¡æµ‹è¯„ç»“æœå¯¹æ¯”
4. **æƒé™æ§åˆ¶**ï¼šçº¢å¨˜æŸ¥çœ‹ä¼šå‘˜æµ‹è¯„ç»“æœçš„æƒé™ç®¡ç†

---

**åˆ›å»ºæ—¶é—´**ï¼š2026-01-12  
**ç‰ˆæœ¬**ï¼šv1.0  
**ä½œè€…**ï¼šAI Assistant

