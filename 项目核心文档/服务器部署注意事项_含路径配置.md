# å¹¸ç¦åŠ›é¡¹ç›®å®Œæ•´éƒ¨ç½²æŒ‡å—ï¼ˆå«æ­£ç¡®è·¯å¾„é…ç½®ï¼‰

> æœ¬æ–‡æ¡£æ€»ç»“äº†é¡¹ç›®éƒ¨ç½²çš„å®Œæ•´æµç¨‹å’Œæ‰€æœ‰å…³é”®æ³¨æ„äº‹é¡¹ï¼Œç‰¹åˆ«æ˜¯å‰åç«¯è·¯å¾„é…ç½®é—®é¢˜ã€‚

## ğŸ“‹ ç›®å½•

1. [æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡](#1-æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡)
2. [SSHå¯†é’¥é…ç½®](#2-sshå¯†é’¥é…ç½®)
3. [æ•°æ®åº“é…ç½®](#3-æ•°æ®åº“é…ç½®)
4. [åç«¯éƒ¨ç½²](#4-åç«¯éƒ¨ç½²)
5. [å‰ç«¯éƒ¨ç½²ï¼ˆå…³é”®ï¼šè·¯å¾„é…ç½®ï¼‰](#5-å‰ç«¯éƒ¨ç½²å…³é”®è·¯å¾„é…ç½®)
6. [Nginxé…ç½®](#6-nginxé…ç½®)
7. [æœåŠ¡å¯åŠ¨ä¸éªŒè¯](#7-æœåŠ¡å¯åŠ¨ä¸éªŒè¯)
8. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#8-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## 1. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 1.1 åŸºç¡€è½¯ä»¶å®‰è£…

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…å¿…è¦è½¯ä»¶
sudo apt install -y curl git nginx mysql-server redis-server

# å®‰è£… Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰
sudo npm install -g pm2
```

### 1.2 åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
sudo mkdir -p /www/projects/xinfu-project
sudo chown -R $USER:$USER /www/projects/xinfu-project
```

---

## 2. SSHå¯†é’¥é…ç½®

### 2.1 æœ¬åœ°ç”Ÿæˆæˆ–ä¸‹è½½å¯†é’¥

**æ–¹å¼ä¸€ï¼šè…¾è®¯äº‘æ§åˆ¶å°åˆ›å»ºå¯†é’¥**
1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥"äº‘æœåŠ¡å™¨" â†’ "SSHå¯†é’¥"
3. åˆ›å»ºå¯†é’¥å¹¶ä¸‹è½½ï¼ˆå¦‚ `XFL.pem`ï¼‰
4. ç»‘å®šåˆ°æœåŠ¡å™¨å®ä¾‹
5. é‡å¯æœåŠ¡å™¨

**æ–¹å¼äºŒï¼šæœ¬åœ°ç”Ÿæˆå¯†é’¥**
```bash
ssh-keygen -t rsa -b 4096 -f ~/.ssh/xinfu_key
```

### 2.2 é…ç½®æœ¬åœ°å¯†é’¥

```bash
# ç§»åŠ¨å¯†é’¥æ–‡ä»¶åˆ° .ssh ç›®å½•
mv ~/Downloads/XFL.pem ~/.ssh/
chmod 400 ~/.ssh/XFL.pem

# æµ‹è¯•è¿æ¥
ssh -i ~/.ssh/XFL.pem ubuntu@YOUR_SERVER_IP
```

### 2.3 é…ç½® SSH åˆ«åï¼ˆå¯é€‰ï¼‰

ç¼–è¾‘ `~/.ssh/config`ï¼š
```
Host xinfu-server
    HostName 124.222.88.25
    User ubuntu
    IdentityFile ~/.ssh/XFL.pem
    ServerAliveInterval 60
```

ä½¿ç”¨ï¼š`ssh xinfu-server`

---

## 3. æ•°æ®åº“é…ç½®

### 3.1 MySQLé…ç½®

```bash
# ç™»å½•MySQL
sudo mysql -u root

# ä¿®æ”¹rootç”¨æˆ·è®¤è¯æ–¹å¼ï¼ˆé‡è¦ï¼ï¼‰
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'your_strong_password';
FLUSH PRIVILEGES;

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS xinfu_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# é€€å‡º
EXIT;
```

### 3.2 å¯¼å…¥æ•°æ®

```bash
mysql -u root -p xinfu_db < /path/to/database/01_create_database.sql
mysql -u root -p xinfu_db < /path/to/database/02_create_tables.sql
mysql -u root -p xinfu_db < /path/to/database/03_init_data.sql
# ... ä¾æ¬¡å¯¼å…¥å…¶ä»–SQLæ–‡ä»¶
```

### 3.3 Redisé…ç½®

```bash
# å¯åŠ¨Redis
sudo systemctl start redis-server
sudo systemctl enable redis-server

# éªŒè¯
redis-cli ping
# åº”è¿”å›ï¼šPONG
```

---

## 4. åç«¯éƒ¨ç½²

### 4.1 ä¸Šä¼ ä»£ç 

```bash
# åœ¨æœ¬åœ°é¡¹ç›®æ ¹ç›®å½•
cd /path/to/local/project

# æ‰“åŒ…åç«¯ä»£ç 
tar -czf backend.tar.gz backend/

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -i ~/.ssh/XFL.pem backend.tar.gz ubuntu@YOUR_SERVER_IP:/www/projects/xinfu-project/

# åœ¨æœåŠ¡å™¨ä¸Šè§£å‹
ssh -i ~/.ssh/XFL.pem ubuntu@YOUR_SERVER_IP
cd /www/projects/xinfu-project
tar -xzf backend.tar.gz
```

### 4.2 é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `/www/projects/xinfu-project/backend/.env`ï¼š

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_strong_password
DB_DATABASE=xinfu_db

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379

# JWTé…ç½®
JWT_SECRET=your_jwt_secret_key_at_least_32_characters_long
JWT_EXPIRES_IN=7d

# åº”ç”¨é…ç½®
NODE_ENV=production
PORT=3001

# OSSé…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
OSS_REGION=your_region
OSS_ACCESS_KEY_ID=your_access_key
OSS_ACCESS_KEY_SECRET=your_secret_key
OSS_BUCKET=your_bucket_name
```

### 4.3 å®‰è£…ä¾èµ–å’Œæ„å»º

```bash
cd /www/projects/xinfu-project/backend

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºï¼ˆç¼–è¯‘TypeScriptï¼‰
npm run build

# éªŒè¯æ„å»ºäº§ç‰©
ls -la dist/
# åº”è¯¥çœ‹åˆ° main.js ç­‰æ–‡ä»¶
```

### 4.4 é…ç½®PM2

åˆ›å»º `/www/projects/xinfu-project/backend/pm2.config.js`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'xinfu-backend',
    script: './dist/main.js',
    cwd: '/www/projects/xinfu-project/backend',
    instances: 1,
    exec_mode: 'cluster',
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    error_file: './logs/error.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    merge_logs: true
  }]
}
```

### 4.5 å¯åŠ¨åç«¯

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p /www/projects/xinfu-project/backend/logs

# å¯åŠ¨æœåŠ¡
pm2 start pm2.config.js

# ä¿å­˜PM2é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
# æ‰§è¡Œè¾“å‡ºçš„å‘½ä»¤

# æŸ¥çœ‹çŠ¶æ€
pm2 status
pm2 logs xinfu-backend
```

---

## 5. å‰ç«¯éƒ¨ç½²ï¼ˆå…³é”®ï¼šè·¯å¾„é…ç½®ï¼‰

### âš ï¸ æœ€é‡è¦çš„é…ç½®ï¼šVite Baseè·¯å¾„

è¿™æ˜¯**æœ€å®¹æ˜“å‡ºé”™**çš„åœ°æ–¹ï¼å¿…é¡»æ­£ç¡®é…ç½®ï¼Œå¦åˆ™é¡µé¢ä¼šå‡ºç°404æˆ–åŠ è½½é”™è¯¯çš„èµ„æºã€‚

### 5.1 H5å‰ç«¯é…ç½®

ç¼–è¾‘ `frontend-h5/vite.config.ts`ï¼š

```typescript
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import Components from 'unplugin-vue-components/vite'
import { VantResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  base: '/h5/',  // â­ å…³é”®é…ç½®ï¼šè®¾ç½®åŸºç¡€è·¯å¾„
  plugins: [
    vue(),
    Components({
      resolvers: [VantResolver()],
    }),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    port: 5174,
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
      }
    }
  }
})
```

**å…³é”®è¯´æ˜ï¼š**
- `base: '/h5/'` ä¼šè®©Viteåœ¨æ„å»ºæ—¶å°†æ‰€æœ‰èµ„æºè·¯å¾„æ”¹ä¸º `/h5/assets/xxx`
- å¦‚æœä¸é…ç½®ï¼Œé»˜è®¤æ˜¯ `/assets/xxx`ï¼Œä¼šå¯¼è‡´404

### 5.2 Adminå‰ç«¯é…ç½®

ç¼–è¾‘ `frontend-admin/vite.config.ts`ï¼š

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { fileURLToPath, URL } from 'node:url'

export default defineConfig({
  base: '/admin/',  // â­ å…³é”®é…ç½®ï¼šè®¾ç½®åŸºç¡€è·¯å¾„
  plugins: [vue()],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    port: 5175,
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
      }
    }
  }
})
```

### 5.3 æœ¬åœ°æ„å»ºå‰ç«¯

```bash
# æ„å»ºH5å‰ç«¯
cd frontend-h5
npm install
npx vite build

# éªŒè¯æ„å»ºç»“æœï¼ˆé‡è¦ï¼ï¼‰
cat dist/index.html
# åº”è¯¥çœ‹åˆ°ï¼šsrc="/h5/assets/index-xxx.js"
# è€Œä¸æ˜¯ï¼šsrc="/assets/index-xxx.js"

# æ„å»ºAdminå‰ç«¯
cd ../frontend-admin
npm install
npx vite build

# éªŒè¯æ„å»ºç»“æœ
cat dist/index.html
# åº”è¯¥çœ‹åˆ°ï¼šsrc="/admin/assets/index-xxx.js"
```

### 5.4 ä¸Šä¼ å‰ç«¯åˆ°æœåŠ¡å™¨

```bash
# åœ¨æœ¬åœ°é¡¹ç›®æ ¹ç›®å½•
cd /path/to/local/project

# ä¸Šä¼ H5å‰ç«¯
scp -i ~/.ssh/XFL.pem -r frontend-h5/dist ubuntu@YOUR_SERVER_IP:/tmp/h5-dist

# ä¸Šä¼ Adminå‰ç«¯
scp -i ~/.ssh/XFL.pem -r frontend-admin/dist ubuntu@YOUR_SERVER_IP:/tmp/admin-dist
```

### 5.5 æœåŠ¡å™¨ä¸Šéƒ¨ç½²å‰ç«¯

```bash
ssh -i ~/.ssh/XFL.pem ubuntu@YOUR_SERVER_IP

# åˆ›å»ºå‰ç«¯ç›®å½•
sudo mkdir -p /www/projects/xinfu-project/frontend-h5
sudo mkdir -p /www/projects/xinfu-project/frontend-admin

# ç§»åŠ¨æ–‡ä»¶
sudo mv /tmp/h5-dist /www/projects/xinfu-project/frontend-h5/dist
sudo mv /tmp/admin-dist /www/projects/xinfu-project/frontend-admin/dist

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data /www/projects/xinfu-project/frontend-h5/dist
sudo chown -R www-data:www-data /www/projects/xinfu-project/frontend-admin/dist
```

---

## 6. Nginxé…ç½®

### 6.1 åˆ›å»ºNginxé…ç½®æ–‡ä»¶

åˆ›å»º `/etc/nginx/sites-available/xinfu.conf`ï¼š

```nginx
server {
    listen 8080;
    server_name _;

    # å¼€å‘ç¯å¢ƒï¼šç¦ç”¨ç¼“å­˜ï¼ˆç”Ÿäº§ç¯å¢ƒå¯åˆ é™¤æ­¤æ®µï¼‰
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
    add_header Pragma "no-cache";
    expires -1;

    # ==================== H5 å‰å°é¡µé¢ ====================
    # é‡å®šå‘ /h5 åˆ° /h5/
    location = /h5 {
        return 301 /h5/;
    }
    
    location /h5/ {
        alias /www/projects/xinfu-project/frontend-h5/dist/;
        try_files $uri $uri/ /h5/index.html;
        index index.html;
    }

    # ==================== Admin åå°é¡µé¢ ====================
    # é‡å®šå‘ /admin åˆ° /admin/
    location = /admin {
        return 301 /admin/;
    }
    
    location /admin/ {
        alias /www/projects/xinfu-project/frontend-admin/dist/;
        try_files $uri $uri/ /admin/index.html;
        index index.html;
    }

    # ==================== API æ¥å£ ====================
    location /api {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 6.2 å¯ç”¨é…ç½®å¹¶é‡å¯Nginx

```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -sf /etc/nginx/sites-available/xinfu.conf /etc/nginx/sites-enabled/

# åˆ é™¤é»˜è®¤é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
sudo rm -f /etc/nginx/sites-enabled/default

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable nginx
```

### 6.3 é…ç½®è¯´æ˜

**å…³é”®ç‚¹ï¼š**
1. `location /h5/` ä½¿ç”¨ `alias`ï¼Œä¸æ˜¯ `root`
2. `alias` è·¯å¾„å¿…é¡»ä»¥ `/` ç»“å°¾
3. `try_files` çš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯ `/h5/index.html`ï¼ˆç”¨äºSPAè·¯ç”±ï¼‰
4. å¿…é¡»é…ç½® `location = /h5` çš„301é‡å®šå‘

**è·¯å¾„æ˜ å°„å…³ç³»ï¼š**
- è¯·æ±‚ `http://server/h5/assets/index.js`
- Nginxæ˜ å°„åˆ° `/www/projects/xinfu-project/frontend-h5/dist/assets/index.js`

---

## 7. æœåŠ¡å¯åŠ¨ä¸éªŒè¯

### 7.1 å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# å¯åŠ¨MySQL
sudo systemctl start mysql
sudo systemctl status mysql

# å¯åŠ¨Redis
sudo systemctl start redis-server
sudo systemctl status redis-server

# å¯åŠ¨åç«¯ï¼ˆPM2ï¼‰
cd /www/projects/xinfu-project/backend
pm2 start pm2.config.js
pm2 status

# å¯åŠ¨Nginx
sudo systemctl start nginx
sudo systemctl status nginx
```

### 7.2 éªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep -E '3001|3306|6379|8080'

# æ£€æŸ¥åç«¯API
curl http://localhost:3001/api/v1/health
# åº”è¿”å›ï¼š{"status":"ok"}

# æ£€æŸ¥Nginx
curl -I http://localhost:8080/h5/
# åº”è¿”å›ï¼š200 OK

# æŸ¥çœ‹åç«¯æ—¥å¿—
pm2 logs xinfu-backend --lines 50
```

### 7.3 æµè§ˆå™¨è®¿é—®

- **H5å‰å°ï¼š** `http://YOUR_SERVER_IP:8080/h5/`
- **Adminåå°ï¼š** `http://YOUR_SERVER_IP:8080/admin/`

âš ï¸ **æ³¨æ„ï¼šURLæœ«å°¾å¿…é¡»å¸¦ `/`**

---

## 8. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 8.1 å‰ç«¯é¡µé¢ç©ºç™½æˆ–404

**ç—‡çŠ¶ï¼š**
- æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º `Failed to load resource: 404 (Not Found)`
- èµ„æºè·¯å¾„é”™è¯¯ï¼ˆå¦‚åŠ è½½ `/assets/xxx` è€Œä¸æ˜¯ `/h5/assets/xxx`ï¼‰

**åŸå› ï¼š**
- Viteé…ç½®ä¸­ç¼ºå°‘ `base` è·¯å¾„

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// vite.config.ts
export default defineConfig({
  base: '/h5/',  // æ·»åŠ è¿™ä¸€è¡Œï¼
  // ... å…¶ä»–é…ç½®
})
```

é‡æ–°æ„å»ºå¹¶ä¸Šä¼ ï¼š
```bash
npx vite build
scp -i ~/.ssh/XFL.pem -r dist ubuntu@YOUR_SERVER_IP:/tmp/h5-dist
```

### 8.2 æµè§ˆå™¨ç¼“å­˜å¯¼è‡´åŠ è½½æ—§æ–‡ä»¶

**ç—‡çŠ¶ï¼š**
- æ˜æ˜æ›´æ–°äº†æ–‡ä»¶ï¼Œä½†æµè§ˆå™¨è¿˜æ˜¯æ˜¾ç¤ºæ—§å†…å®¹
- F5åˆ·æ–°æ— æ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
1. **å¼ºåˆ¶åˆ·æ–°ï¼š** `Ctrl + Shift + R` (Windows/Linux) æˆ– `Cmd + Shift + R` (Mac)
2. **æ— ç—•æ¨¡å¼ï¼š** å¼€å¯æ— ç—•/éšç§æ¨¡å¼è®¿é—®
3. **Nginxé…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ï¼š**
```nginx
add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
add_header Pragma "no-cache";
expires -1;
```

### 8.3 H5åŠ è½½Adminèµ„æºï¼ˆæˆ–åè¿‡æ¥ï¼‰

**ç—‡çŠ¶ï¼š**
- H5é¡µé¢å°è¯•åŠ è½½ `/admin/assets/xxx`
- æ§åˆ¶å°å‡ºç°æ ·å¼é”™è¯¯æˆ–JSé”™è¯¯

**åŸå› ï¼š**
- Viteé…ç½®çš„ `base` è·¯å¾„é”™è¯¯
- æˆ–è€…æ„å»ºåä¸Šä¼ åˆ°äº†é”™è¯¯çš„ç›®å½•

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `vite.config.ts` çš„ `base` é…ç½®
2. æ£€æŸ¥æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ä½ç½®
3. æ£€æŸ¥Nginxçš„ `alias` è·¯å¾„

### 8.4 åç«¯æ— æ³•è¿æ¥æ•°æ®åº“

**ç—‡çŠ¶ï¼š**
- PM2æ—¥å¿—æ˜¾ç¤º `Access denied for user 'root'@'localhost'`
- æˆ– `ER_NOT_SUPPORTED_AUTH_MODE`

**åŸå› ï¼š**
- MySQLé»˜è®¤ä½¿ç”¨ `auth_socket` è®¤è¯
- æˆ–å¯†ç ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆï¼š**
```sql
-- ç™»å½•MySQL
sudo mysql -u root

-- ä¿®æ”¹è®¤è¯æ–¹å¼
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'your_password';
FLUSH PRIVILEGES;
```

æ›´æ–° `backend/.env`ï¼š
```env
DB_PASSWORD=your_password
```

é‡å¯åç«¯ï¼š
```bash
pm2 restart xinfu-backend
```

### 8.5 PM2å¯åŠ¨å¤±è´¥ï¼šmain.js not found

**ç—‡çŠ¶ï¼š**
- PM2æ˜¾ç¤ºé”™è¯¯ï¼š`Error: Script not found: /path/to/main.js`

**åŸå› ï¼š**
- åç«¯æœªæ„å»ºï¼Œæˆ–æ„å»ºå¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
cd /www/projects/xinfu-project/backend

# é‡æ–°æ„å»º
npm run build

# æ£€æŸ¥æ„å»ºäº§ç‰©
ls -la dist/main.js

# é‡å¯PM2
pm2 restart xinfu-backend
```

### 8.6 Nginx 403 Forbidden

**ç—‡çŠ¶ï¼š**
- è®¿é—®é¡µé¢æ˜¾ç¤º `403 Forbidden`

**åŸå› ï¼š**
- æ–‡ä»¶æƒé™ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ä¿®å¤æƒé™
sudo chown -R www-data:www-data /www/projects/xinfu-project/frontend-h5/dist
sudo chown -R www-data:www-data /www/projects/xinfu-project/frontend-admin/dist

# ç¡®ä¿æ–‡ä»¶å¯è¯»
sudo chmod -R 755 /www/projects/xinfu-project/frontend-h5/dist
sudo chmod -R 755 /www/projects/xinfu-project/frontend-admin/dist

# é‡å¯Nginx
sudo systemctl restart nginx
```

### 8.7 APIè¯·æ±‚å¤±è´¥ï¼ˆ401/403ï¼‰

**ç—‡çŠ¶ï¼š**
- å‰ç«¯è¯·æ±‚APIè¿”å› `401 Unauthorized`
- æˆ–æŸäº›æ¥å£æ— æ³•è®¿é—®

**åŸå› ï¼š**
- JWT Tokenè¿‡æœŸæˆ–æ— æ•ˆ
- åç«¯æƒé™é…ç½®é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ¸…é™¤æµè§ˆå™¨LocalStorageï¼Œé‡æ–°ç™»å½•
2. æ£€æŸ¥åç«¯æ—¥å¿—ï¼š`pm2 logs xinfu-backend`
3. éªŒè¯Tokené…ç½®ï¼š`backend/.env` ä¸­çš„ `JWT_SECRET`

---

## 9. éƒ¨ç½²è„šæœ¬ï¼ˆä¸€é”®éƒ¨ç½²ï¼‰

### 9.1 åˆ›å»ºæœ¬åœ°éƒ¨ç½²è„šæœ¬

åˆ›å»º `deployment/deploy.sh`ï¼š

```bash
#!/bin/bash
set -e

SERVER_IP="124.222.88.25"
SSH_KEY="~/.ssh/XFL.pem"
SERVER_USER="ubuntu"
PROJECT_DIR="/www/projects/xinfu-project"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "   å¹¸ç¦åŠ›é¡¹ç›®ä¸€é”®éƒ¨ç½²è„šæœ¬"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# 1. æ„å»ºå‰ç«¯
echo "ğŸ“¦ [1/5] æ„å»ºå‰ç«¯..."
cd frontend-h5
npm install
npx vite build
cd ..

cd frontend-admin
npm install
npx vite build
cd ..

echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
echo ""

# 2. ä¸Šä¼ å‰ç«¯
echo "ğŸ“¤ [2/5] ä¸Šä¼ å‰ç«¯åˆ°æœåŠ¡å™¨..."
scp -i $SSH_KEY -r frontend-h5/dist $SERVER_USER@$SERVER_IP:/tmp/h5-dist
scp -i $SSH_KEY -r frontend-admin/dist $SERVER_USER@$SERVER_IP:/tmp/admin-dist
echo "âœ… å‰ç«¯ä¸Šä¼ å®Œæˆ"
echo ""

# 3. éƒ¨ç½²å‰ç«¯
echo "ğŸš€ [3/5] éƒ¨ç½²å‰ç«¯..."
ssh -i $SSH_KEY $SERVER_USER@$SERVER_IP << 'ENDSSH'
sudo rm -rf /www/projects/xinfu-project/frontend-h5/dist
sudo rm -rf /www/projects/xinfu-project/frontend-admin/dist
sudo mv /tmp/h5-dist /www/projects/xinfu-project/frontend-h5/dist
sudo mv /tmp/admin-dist /www/projects/xinfu-project/frontend-admin/dist
sudo chown -R www-data:www-data /www/projects/xinfu-project/frontend-h5/dist
sudo chown -R www-data:www-data /www/projects/xinfu-project/frontend-admin/dist
ENDSSH
echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆ"
echo ""

# 4. æ„å»ºåç«¯
echo "ğŸ”§ [4/5] æ„å»ºåç«¯..."
cd backend
npm install
npm run build
cd ..
echo "âœ… åç«¯æ„å»ºå®Œæˆ"
echo ""

# 5. ä¸Šä¼ å¹¶éƒ¨ç½²åç«¯
echo "ğŸ“¤ [5/5] ä¸Šä¼ å¹¶éƒ¨ç½²åç«¯..."
scp -i $SSH_KEY -r backend/dist $SERVER_USER@$SERVER_IP:/tmp/backend-dist
ssh -i $SSH_KEY $SERVER_USER@$SERVER_IP << 'ENDSSH'
rm -rf /www/projects/xinfu-project/backend/dist
mv /tmp/backend-dist /www/projects/xinfu-project/backend/dist
cd /www/projects/xinfu-project/backend
pm2 restart xinfu-backend
ENDSSH
echo "âœ… åç«¯éƒ¨ç½²å®Œæˆ"
echo ""

# 6. é‡å¯Nginx
echo "ğŸ”„ é‡å¯Nginx..."
ssh -i $SSH_KEY $SERVER_USER@$SERVER_IP "sudo systemctl restart nginx"
echo "âœ… Nginxé‡å¯å®Œæˆ"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "   âœ… éƒ¨ç½²å®Œæˆï¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "è®¿é—®åœ°å€ï¼š"
echo "  H5å‰å°: http://$SERVER_IP:8080/h5/"
echo "  Adminåå°: http://$SERVER_IP:8080/admin/"
echo ""
```

ä½¿ç”¨ï¼š
```bash
chmod +x deployment/deploy.sh
./deployment/deploy.sh
```

---

## 10. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å»ºè®®

### 10.1 å®‰å…¨é…ç½®

```bash
# é…ç½®é˜²ç«å¢™
sudo ufw allow 22    # SSH
sudo ufw allow 8080  # Nginx
sudo ufw enable

# ä¿®æ”¹SSHç«¯å£ï¼ˆå¯é€‰ï¼‰
sudo vim /etc/ssh/sshd_config
# Port 22 æ”¹ä¸º Port 2222
sudo systemctl restart sshd
```

### 10.2 æ€§èƒ½ä¼˜åŒ–

**Nginxå¼€å¯Gzipï¼š**
```nginx
# åœ¨ http å—ä¸­æ·»åŠ 
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript 
           application/json application/javascript application/xml+rss;
```

**å‰ç«¯ä»£ç åˆ†å‰²ï¼š**
```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vue-vendor': ['vue', 'vue-router', 'pinia'],
          'vant-vendor': ['vant'],
          'chart-vendor': ['echarts']
        }
      }
    }
  }
})
```

### 10.3 ç›‘æ§å’Œæ—¥å¿—

```bash
# é…ç½®PM2ç›‘æ§
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 100M
pm2 set pm2-logrotate:retain 7

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
pm2 monit

# è®¾ç½®æ—¥å¿—è½®è½¬
sudo vim /etc/logrotate.d/nginx
```

### 10.4 æ•°æ®åº“å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /home/ubuntu/backup-db.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/home/ubuntu/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
mysqldump -u root -p'your_password' xinfu_db > $BACKUP_DIR/xinfu_db_$DATE.sql
# ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "xinfu_db_*.sql" -mtime +7 -delete
EOF

chmod +x /home/ubuntu/backup-db.sh

# æ·»åŠ åˆ°crontabï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
crontab -e
# 0 2 * * * /home/ubuntu/backup-db.sh
```

---

## 11. æ•…éšœæ’æŸ¥æ¸…å•

é‡åˆ°é—®é¢˜æ—¶ï¼ŒæŒ‰æ­¤æ¸…å•é€æ­¥æ£€æŸ¥ï¼š

### âœ… æœåŠ¡æ£€æŸ¥
- [ ] MySQLè¿è¡Œæ­£å¸¸ï¼š`sudo systemctl status mysql`
- [ ] Redisè¿è¡Œæ­£å¸¸ï¼š`sudo systemctl status redis-server`
- [ ] åç«¯è¿è¡Œæ­£å¸¸ï¼š`pm2 status`
- [ ] Nginxè¿è¡Œæ­£å¸¸ï¼š`sudo systemctl status nginx`

### âœ… ç«¯å£æ£€æŸ¥
- [ ] 3001ç«¯å£è¢«åç«¯å ç”¨ï¼š`sudo netstat -tlnp | grep 3001`
- [ ] 8080ç«¯å£è¢«Nginxå ç”¨ï¼š`sudo netstat -tlnp | grep 8080`
- [ ] 3306ç«¯å£è¢«MySQLå ç”¨ï¼š`sudo netstat -tlnp | grep 3306`

### âœ… æ—¥å¿—æ£€æŸ¥
- [ ] åç«¯æ—¥å¿—ï¼š`pm2 logs xinfu-backend --lines 50`
- [ ] Nginxé”™è¯¯æ—¥å¿—ï¼š`sudo tail -n 50 /var/log/nginx/error.log`
- [ ] MySQLæ—¥å¿—ï¼š`sudo tail -n 50 /var/log/mysql/error.log`

### âœ… æ–‡ä»¶æ£€æŸ¥
- [ ] å‰ç«¯æ–‡ä»¶å­˜åœ¨ï¼š`ls -la /www/projects/xinfu-project/frontend-h5/dist/`
- [ ] åç«¯æ–‡ä»¶å­˜åœ¨ï¼š`ls -la /www/projects/xinfu-project/backend/dist/main.js`
- [ ] Nginxé…ç½®æ­£ç¡®ï¼š`sudo nginx -t`

### âœ… æµè§ˆå™¨æ£€æŸ¥
- [ ] æ¸…é™¤ç¼“å­˜æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼
- [ ] æ£€æŸ¥æ§åˆ¶å°é”™è¯¯
- [ ] æ£€æŸ¥Networké¢æ¿çš„è¯·æ±‚è·¯å¾„

---

## 12. è”ç³»ä¸æ”¯æŒ

å¦‚æœé‡åˆ°æœ¬æ–‡æ¡£æœªè¦†ç›–çš„é—®é¢˜ï¼š

1. æŸ¥çœ‹é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„å…¶ä»–æ–‡æ¡£
2. æ£€æŸ¥ `backend/logs/` ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶
3. ä½¿ç”¨ `pm2 logs` æŸ¥çœ‹å®æ—¶æ—¥å¿—
4. æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Consoleå’ŒNetworké¢æ¿

---

## é™„å½•ï¼šå¿«é€Ÿå‘½ä»¤å‚è€ƒ

### æœåŠ¡ç®¡ç†
```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
pm2 status
sudo systemctl status nginx mysql redis-server

# é‡å¯æ‰€æœ‰æœåŠ¡
pm2 restart all
sudo systemctl restart nginx

# æŸ¥çœ‹æ—¥å¿—
pm2 logs --lines 50
sudo tail -f /var/log/nginx/error.log
```

### æ•°æ®åº“æ“ä½œ
```bash
# ç™»å½•MySQL
mysql -u root -p xinfu_db

# å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p xinfu_db > backup.sql

# æ¢å¤æ•°æ®åº“
mysql -u root -p xinfu_db < backup.sql
```

### å‰ç«¯æ›´æ–°
```bash
# æœ¬åœ°æ„å»º
cd frontend-h5 && npx vite build && cd ..
cd frontend-admin && npx vite build && cd ..

# ä¸Šä¼ 
scp -i ~/.ssh/XFL.pem -r frontend-h5/dist ubuntu@SERVER_IP:/tmp/h5-dist
scp -i ~/.ssh/XFL.pem -r frontend-admin/dist ubuntu@SERVER_IP:/tmp/admin-dist

# éƒ¨ç½²ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šï¼‰
sudo rm -rf /www/projects/xinfu-project/frontend-{h5,admin}/dist
sudo mv /tmp/{h5,admin}-dist /www/projects/xinfu-project/frontend-{h5,admin}/dist
sudo chown -R www-data:www-data /www/projects/xinfu-project/frontend-*/dist
sudo systemctl restart nginx
```

### åç«¯æ›´æ–°
```bash
# æœ¬åœ°æ„å»º
cd backend && npm run build && cd ..

# ä¸Šä¼ 
scp -i ~/.ssh/XFL.pem -r backend/dist ubuntu@SERVER_IP:/tmp/backend-dist

# éƒ¨ç½²ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šï¼‰
rm -rf /www/projects/xinfu-project/backend/dist
mv /tmp/backend-dist /www/projects/xinfu-project/backend/dist
pm2 restart xinfu-backend
```

---

**æœ€åæ›´æ–°ï¼š** 2026-01-28  
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**ç»´æŠ¤è€…ï¼š** å¹¸ç¦åŠ›é¡¹ç›®å¼€å‘å›¢é˜Ÿ
