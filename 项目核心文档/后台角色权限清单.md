# 幸福力婚恋系统 - 后台角色权限清单

## 📋 超级管理员初始账号

| 项目 | 值 |
|------|-----|
| **用户名** | `admin` |
| **密码** | `admin123` |
| **角色** | `super_admin` (超级管理员) |
| **状态** | `1` (正常) |
| **所属门店** | `XFL001` (总部测试门店) |

> **重要提示**：
> - 首次部署后请立即修改默认密码
> - 该账号已在数据库初始化脚本 `database/03_init_data.sql` 中配置
> - 密码已使用 BCrypt 加密存储

---

## 🔐 四级角色体系

系统实现了基于角色的访问控制 (RBAC)，共定义四种后台用户角色：

| 角色代码 | 角色名称 | 中文描述 | 权限级别 |
|---------|---------|---------|---------|
| `super_admin` | Super Admin | 超级管理员 | ⭐⭐⭐⭐⭐ |
| `admin` | Store Admin | 门店老板 | ⭐⭐⭐⭐ |
| `manager` | Store Manager | 门店负责人 | ⭐⭐⭐ |
| `matchmaker` | Matchmaker | 普通红娘 | ⭐⭐ |

---

## 📊 角色权限矩阵

### 1️⃣ 超级管理员 (super_admin)

**权限范围**：全平台最高权限，不受门店隔离限制。

| 功能模块 | 具体权限 | API 接口 |
|---------|---------|---------|
| **门店管理** | ✅ 创建门店 | `POST /api/v1/stores` |
| | ✅ 更新门店信息 | `PATCH /api/v1/stores/:id` |
| | ✅ 禁用/启用门店 | `PATCH /api/v1/stores/:id/toggle-status` |
| | ✅ 删除门店 | `DELETE /api/v1/stores/:id` |
| | ✅ 查看所有门店 | `GET /api/v1/stores` |
| **后台人员管理** | ✅ 创建后台用户 | `POST /api/v1/users/sys` |
| | ✅ 审核后台人员注册 | `PATCH /api/v1/users/sys/:id/approve` |
| | ✅ 更新人员状态 | `PATCH /api/v1/users/sys/:id/status` |
| | ✅ 分配/修改角色 | `PATCH /api/v1/users/sys/:id/role` |
| | ✅ 重置用户密码 | `PATCH /api/v1/users/sys/:id/reset-password` |
| | ✅ 查看所有后台人员 | `GET /api/v1/users/sys` |
| **前台用户管理** | ✅ 查看所有门店用户 | `GET /api/v1/users/app` (无门店限制) |
| | ✅ 查看/编辑用户档案 | `GET/PATCH /api/v1/users/profile/:userId` |
| **数据访问** | ✅ 跨门店访问数据 | - |
| | ✅ 查看完整手机号 | - |

**关键特性**：
- 拥有所有接口访问权限（权限守卫自动通过）
- 不受 `store_id` 门店隔离限制
- 可以管理所有门店的人员和数据

---

### 2️⃣ 门店老板 (admin)

**权限范围**：拥有**本门店**最高权限，可管理本门店所有人员和数据。

| 功能模块 | 具体权限 | API 接口 |
|---------|---------|---------|
| **门店人员管理** | ✅ 创建本门店后台用户 | `POST /api/v1/users/sys` |
| | ✅ 审核本门店人员注册 | `PATCH /api/v1/users/sys/:id/approve` |
| | ✅ 更新本门店人员状态 | `PATCH /api/v1/users/sys/:id/status` |
| | ✅ 分配角色 (除 admin 外) | `PATCH /api/v1/users/sys/:id/role` |
| | ✅ 查看本门店后台人员 | `GET /api/v1/users/sys?storeId=xxx` |
| **前台用户管理** | ✅ 查看本门店会员列表 | `GET /api/v1/users/app` |
| | ✅ 查看/编辑会员档案 | `GET/PATCH /api/v1/users/profile/:userId` |
| | ✅ 查看完整手机号 | - |
| **门店管理** | ❌ 不能创建/修改门店 | - |

**关键限制**：
- 只能管理本门店 (`store_id`) 的人员和数据
- 不能分配 `admin` (门店老板) 角色
- 不能跨门店访问数据

---

### 3️⃣ 门店负责人 (manager)

**权限范围**：可查看本门店所有数据，管理红娘服务分配。

| 功能模块 | 具体权限 | API 接口 |
|---------|---------|---------|
| **人员查看** | ✅ 查看本门店后台人员 | `GET /api/v1/users/sys` |
| | ❌ 不能创建/审核/禁用人员 | - |
| **前台用户管理** | ✅ 查看本门店会员列表 | `GET /api/v1/users/app` |
| | ✅ 查看/编辑会员档案 | `GET/PATCH /api/v1/users/profile/:userId` |
| | ✅ 分配服务红娘 | `PATCH /api/v1/users/profile/:userId` (修改 `serviceMatchmakerId`) |
| | ✅ 查看完整手机号 | - |
| **匹配与服务** | ✅ 发起智能匹配 | (待开发) |
| | ✅ 记录服务轨迹 | (待开发) |

**关键限制**：
- 只能查看/编辑本门店数据
- 不能管理后台人员账号
- 主要职责是**管理红娘服务分配**

---

### 4️⃣ 普通红娘 (matchmaker)

**权限范围**：仅能查看和编辑**自己服务**的会员资料。

| 功能模块 | 具体权限 | API 接口 |
|---------|---------|---------|
| **前台用户管理** | ✅ 查看本门店会员列表 | `GET /api/v1/users/app` |
| | ✅ 查看自己服务的会员档案 | `GET /api/v1/users/profile/:userId` (需校验 `serviceMatchmakerId`) |
| | ✅ 编辑自己服务的会员档案 | `PATCH /api/v1/users/profile/:userId` |
| | ⚠️ 手机号脱敏显示 | (如 `138****0000`) |
| **匹配与服务** | ✅ 为自己的会员发起匹配 | `智能匹配菜单已开放` |
| | ✅ 记录服务轨迹 | (待开发) |
| **人员管理** | ❌ 不能查看后台人员 | - |
| | ❌ 不能分配服务红娘 | - |

**关键限制**：
- **手机号脱敏**：系统自动将手机号中间4位替换为 `****`
- 只能操作 `serviceMatchmakerId` 为自己的会员
- 不能查看非服务会员的详细档案

---

## 🔒 权限守卫机制

### 1. RolesGuard (角色守卫)

**实现文件**：`backend/src/common/guards/roles.guard.ts`

**工作原理**：
1. 通过 `@Roles()` 装饰器声明接口所需角色
2. 从 JWT Token 中提取当前用户角色
3. **超级管理员自动通过**所有权限校验
4. 其他角色需在声明的角色列表中

**使用示例**：
```typescript
@Patch('sys/:id/role')
@UseGuards(RolesGuard)
@Roles(SysUserRole.SUPER_ADMIN, SysUserRole.ADMIN)
async updateSysUserRole(@Param('id') id: string, @Body('role') role: SysUserRole) {
  return await this.userService.updateSysUserRole(id, role);
}
```

### 2. StoreIsolationGuard (门店隔离守卫)

**实现文件**：`backend/src/common/guards/store-isolation.guard.ts`

**工作原理**：
1. 从 JWT Token 中提取用户所属 `store_id`
2. 自动在数据库查询中注入 `WHERE store_id = ?` 条件
3. **超级管理员不受此限制**（可查看所有门店数据）
4. 其他角色只能访问本门店数据

---

## 📝 接口权限清单

### 用户管理模块 (UserController)

| 接口路径 | 方法 | 功能描述 | 所需角色 | 公开访问 |
|---------|------|---------|---------|---------|
| `/users/register/app` | POST | 前台用户注册 | - | ✅ |
| `/users/register/sys` | POST | 后台人员注册 | - | ✅ |
| `/users/sys` | POST | 创建后台用户 | super_admin, admin | ❌ |
| `/users/sys` | GET | 获取后台人员列表 | super_admin, admin, manager | ❌ |
| `/users/sys/:id/approve` | PATCH | 审核后台人员 | super_admin, admin | ❌ |
| `/users/sys/:id/status` | PATCH | 更新人员状态 | super_admin, admin | ❌ |
| `/users/sys/:id/role` | PATCH | 更新人员角色 | super_admin, admin | ❌ |
| `/users/sys/:id/reset-password` | PATCH | 重置密码 | super_admin | ❌ |
| `/users/app` | GET | 获取前台用户列表 | 所有后台角色 | ❌ |
| `/users/profile/:userId` | GET | 获取用户档案 | 所有后台角色 | ❌ |
| `/users/profile/:userId` | PATCH | 更新用户档案 | admin, manager, matchmaker | ❌ |

### 门店管理模块 (StoreController)

| 接口路径 | 方法 | 功能描述 | 所需角色 | 公开访问 |
|---------|------|---------|---------|---------|
| `/stores` | POST | 创建门店 | super_admin | ❌ |
| `/stores` | GET | 获取门店列表 | - | ✅ |
| `/stores/:id` | GET | 获取门店详情 | - | ✅ |
| `/stores/:id` | PATCH | 更新门店信息 | super_admin | ❌ |
| `/stores/:id/toggle-status` | PATCH | 禁用/启用门店 | super_admin | ❌ |
| `/stores/:id` | DELETE | 删除门店 | super_admin | ❌ |

---

## 🚀 权限系统使用指南

### 1. 首次部署流程

```bash
# 1. 初始化数据库
mysql -u root -p < database/01_create_database.sql
mysql -u root -p < database/02_create_tables.sql
mysql -u root -p < database/03_init_data.sql

# 2. 使用超级管理员登录后台
用户名: admin
密码: admin123

# 3. 立即修改默认密码（建议）
访问后台 -> 个人设置 -> 修改密码
```

### 2. 人员注册审批流程

```
新员工 -> 注册账号 (status=0 待审核)
    ↓
门店老板/超管 -> 登录后台 -> 人员管理 -> 审核通过 (status=1 正常)
    ↓
门店老板/超管 -> 分配角色 (manager/matchmaker/admin)
    ↓
员工 -> 重新登录 -> 开始工作
```

### 3. 角色分配建议

- **超级管理员**：公司总部技术负责人（1-2人）
- **门店老板**：各门店负责人（每店1人）
- **门店负责人**：协助管理的经理（每店1-2人）
- **普通红娘**：一线服务人员（每店多人）

---

## ⚠️ 安全注意事项

1. **密码安全**：
   - 初始密码 `admin123` 仅用于首次部署
   - 生产环境必须立即修改
   - 所有密码使用 BCrypt 加密存储

2. **Token 管理**：
   - JWT Token 存储在 `localStorage`
   - 前端 Key: `admin_token` (后台), `token` (前台)
   - Token 过期时间：24小时（可配置）

3. **数据隔离**：
   - 所有业务表必须包含 `store_id` 字段
   - 查询自动注入门店隔离条件
   - 超管可手动关闭隔离查看跨店数据

4. **手机号脱敏**：
   - 普通红娘自动脱敏：`138****0000`
   - 门店负责人及以上可查看完整号码
   - 脱敏在 API 响应序列化阶段处理

---

## 📌 待开发功能权限

以下功能的权限体系已规划，待后续开发实现：

| 功能模块 | 权限要求 | 备注 |
|---------|---------|------|
| 智能匹配菜单 | manager, matchmaker, admin, super_admin | ✅ 已开放，所有后台角色可见 |
| 智能匹配功能 | manager, matchmaker | 待开发：仅能为本门店用户发起 |
| 匹配结果查看 | manager, matchmaker | 待开发：查看自己发起的匹配 |
| 服务轨迹记录 | manager, matchmaker | 待开发：记录自己服务的用户 |
| MV值方案配置 | super_admin | 配置5套地域方案 |
| 测评题库管理 | super_admin | 如需修改题库 |

---

**文档版本**：v1.0  
**最后更新**：2026-01-14  
**维护人员**：AI Assistant

