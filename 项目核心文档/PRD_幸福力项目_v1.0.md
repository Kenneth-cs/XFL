# 幸福力婚恋系统产品需求文档 (PRD)

| 文档版本 | 日期 | 编写 | 说明 |
| :--- | :--- | :--- | :--- |
| v1.0 | 2026-01-11 | AI Assistant | 基于现有需求文档、算法逻辑及原型图整合输出 |

## 1. 项目概述

本项目旨在构建一套专业的“幸福力”婚恋服务系统，打通线上测评与线下服务闭环。系统包含面向C端用户的**前台H5/Web端**（进行心理测评、档案完善）和面向B端红娘/管理员的**后台管理端**（进行用户管理、智能匹配、服务跟踪）。系统核心在于基于多维度心理学模型（九型人格、依恋关系、婚恋幸福力）和MV（婚恋价值）算法的科学匹配引擎。

## 2. 核心模型与架构原则

### 2.1 多租户门店隔离 (Store-Based Isolation)
*   **逻辑**：系统所有核心业务数据（用户档案、匹配记录、服务轨迹）均严格绑定 `store_id`。
*   **规则**：
    *   **超级管理员**：**不绑定任何门店** (`store_id` 为空)，拥有全局数据视野（Global Scope），可跨店查看数据或通过筛选器查看特定门店数据。
    *   **门店用户（老板/经理/红娘）**：必须绑定所属门店，拥有门店私有视野（Store Private Scope），仅能访问本门店注册的前台用户数据。
    *   **前台用户**：注册时必须选择归属门店，数据归属于该门店。

### 2.2 ID 生成规则引擎
系统需内置严格的ID生成器，确保全局唯一且符合业务语义。

| 对象 | 格式规则 | 示例 | 生成逻辑 |
| :--- | :--- | :--- | :--- |
| **门店 ID** | `XFL` + 3位序列号 | `XFL001` | 按添加顺序递增 |
| **前台用户 ID** | 门店ID + 5位序列号 | `XFL00100030` | 随机偏移量实现不连续，需校验全局唯一 |
| **后台用户 ID** | 门店ID + `G` + 5位序列号 | `XFL001G13702` | 随机偏移量实现不连续，需校验全局唯一 |

### 2.3 动态档案系统
用户档案是系统的核心数据资产，分为两部分：
1.  **同步字段**：用户在前台注册/填写的信息（如姓名、生日、身高、学历），自动同步至后台档案。
2.  **编辑字段**：后台红娘、门店负责人、门店老板可编辑的专业字段（如MV值评分项、红娘评语、服务轨迹），用于辅助匹配计算。
*   **实时计算**：每当档案中涉及MV计算的字段（年龄、身高、学历、收入等）发生变更时，系统需自动重新计算该用户的MV值。

---

## 3. 角色与权限体系 (RBAC)

### 3.1 用户分类
*   **前台用户**：普通C端客户，通过手机号注册。
*   **后台用户**：B端服务人员，用户注册后通过超级管理员审核开通（门店老板可审核和分配红娘、门店负责人的角色权限）。

### 3.2 角色权限矩阵

| 角色 | 权限范围 | 关键限制 |
| :--- | :--- | :--- |
| **前台用户** | 注册登录、完善个人基础资料、进行三大测评、查看测评结果 | 只能看到自己的数据 |
| **后台-普通红娘** | 查看/编辑本门店**自己服务**的会员资料、发起匹配、记录服务轨迹 | **手机号脱敏**，不可见服务会员手机号详情 |
| **后台-门店负责人** | 管理本门店所有会员（分配红娘）、查看所有会员资料 | 可查看手机号，管理门店红娘 |
| **后台-门店老板** | 拥有本门店最高权限，审核和管理门店员工账号（禁用/启用/分配角色） | 仅限本门店范围 |
| **超级管理员** | 平台级权限。**数据范围：全局**。管理所有门店（新增/禁用）、审核后台所有人员准入、角色分配、账号状态管理、密码重置 | 仅特定人员（如总部）持有，不绑定具体门店 |

---

## 4. 业务功能 - 前台用户端 (H5/Web)

### 4.1 注册与登录
*   **注册**：
    *   必填项：大头照、手机号、姓名、出生日期（自动算年龄）、性别、身高、体重、民族、婚况、学历、**注册门店**（下拉选择）。
    *   协议：必须勾选《用户信息获取协议》。
    *   账号生成：注册成功后自动生成前台用户ID。
*   **登录**：
    *   方式：手机号 + 密码。
    *   **跳转逻辑**：登录成功后，默认跳转至 **“测评中心”** 页面；若是从其他需要登录的页面（如答题页）拦截跳转而来，则登录后自动跳回原页面。

### 4.2 心理测评引擎
> **说明**：考虑到专业测评量表的严谨性与稳定性，题目内容将固化在系统中，不提供后台动态编辑功能。

**访问权限**：
*   **获取题目**：API 层面允许未登录访问（便于加载速度），但前端交互上建议在进入答题前校验登录状态。
*   **提交答卷**：必须登录状态下才能提交，后端严格校验 Token。

系统内置三大核心测评，用户答题后实时计算结果。

#### A. 九型人格测试 (Enneagram)
*   **题库**：二选一强制选择题（每题选项对应特定人格类型）。
*   **计算逻辑**：
    1.  累计每个人格（1-9号）的实际得分。
    2.  计算百分比 = 实际得分 / 标准满分。
    3.  **结果判定**：
        *   取百分比最高的Top 3人格。
        *   有效阈值筛选：`(最高分 - 15%)`，低于此阈值的即使是Top 3也不计入（兜底至少保留3个）。
*   **展示**：
    *   柱状图（X轴按百分比降序排列）。
    *   结果文案：显示前三大人格类型及描述。

#### B. 依恋关系测试 (Attachment Style)
*   **题库**：分为焦虑测试、回避测试、安全感测试三组题目。
*   **计算逻辑**：
    *   分别计算 焦虑分(A)、回避分(B)、安全分(C)。
    *   **判定优先级**：紊乱型 (A≥5 & B≥5) > 焦虑型 (A≥5) > 回避型 (B≥5) > 安全型 (C≥5)。
*   **展示**：显示依恋类型标签（如“安全型依恋”）及对应的核心特质、典型行为表现。

#### C. 婚恋幸福力评测 (Happiness Power)
*   **模型**：包含20个维度（如积极性格、积极情绪、积极沟通等）。
*   **计算逻辑**：每个维度独立计分，转换为百分比（0-10分制映射）。
*   **展示 - 幸福力双环图**：
    *   **UI结构**：20个扇形切片，每个扇形分5等份。
    *   **填充规则**：内圈1-4格为得分区（根据得分比例填充），第5格为外围标题区。
    *   **配色**：严格遵循UI规定的20种对应色值。
    *   **建议文案**：根据高分/低分模块动态生成建议（如“您在积极沟通模块得分较低...”）。

### 4.3 个人中心
*   查看个人基础档案。
*   查看三大测评的历史结果（支持重新测试）。

---

## 5. 业务功能 - 后台管理端

### 5.1 系统管理
*   **门店管理**（超管）：新增门店（生成门店ID）、编辑门店信息（绑定MV计算地域方案）、禁用/反禁用门店。
*   **人员管理**：后台用户账号的创建、审核、角色分配、禁用。

### 5.2 用户档案管理
*   **用户列表**：按门店隔离展示，支持多维度筛选。
*   **档案详情 (动态表单)**：
    *   **基础信息**：同步前台注册数据。
    *   **扩展信息**：红娘补充填写（如长相评分、房车情况、家庭背景、收入等）。
    *   **测评结果**：同步前台三大测评结果。
    *   **MV值计算**：系统根据当前档案数据，结合门店绑定的**地域MV方案**，自动计算男/女MV得分。
*   **服务轨迹 (三大轨迹)**：
    1.  **匹配轨迹**：记录与另一用户的匹配任务（关联对方ID，记录双方匹配结果：看中/未看中）。
    2.  **约见轨迹**：记录线下约见情况（关联对方ID，记录约见时间、反馈、恋爱/结婚状态）。
    3.  **治疗轨迹**：记录情感咨询/治疗的服务记录（纯文本记录）。
    *   *注：匹配和约见轨迹需实现双向数据同步，A用户的档案中更新了与B的约见反馈，B用户档案中对应的记录也应可见。*

### 5.3 智能匹配引擎 (核心功能)

#### 5.3.1 匹配流程
1.  **发起匹配**：在特定用户的档案中发起。
2.  **初筛 (Filter)**：
    *   **门店隔离**：仅限同门店用户。
    *   **硬性条件**：年龄区间、身高区间、学历范围。
    *   **排除逻辑**：排除已在“服务轨迹”中存在关联记录的用户（避免重复推）。
3.  **精算 (Score & Rank)**：
    *   **MV匹配**：`|发起方MV - 候选方MV| ≤ 5` 则通过，否则不通过。
    *   **九型人格匹配**：
        *   基于九型人格匹配矩阵（+1, 0, -1分）。
        *   **一票否决**：若存在 `-1` 分（性格互斥），则直接判定为“不通过”。
        *   计算重合度：列出适合的性格类型重合数。
4.  **结果批次化**：
    *   每次匹配操作生成一个**匹配批次**（按时间倒序排列）。
    *   批次内展示所有候选人的匹配详情（MV结果、性格结果、幸福力圆环对比）。

#### 5.3.2 匹配查询
*   支持按发起方/被发起方姓名、ID、手机号模糊搜索历史匹配记录。

---

## 6. 核心算法逻辑详述

### 6.1 MV值计算算法
*   **地域差异化**：系统预设5套地域方案（广东周边、江浙周边、全国普适、京沪、东北新疆）。
*   **计算因子**：
    *   **男方**：年龄、身高、长相、财富、智商（学历）、情商、性能力（年龄推算）、长期专一承诺（幸福力得分推算）。
    *   **女方**：年龄、BMI（身高体重推算）、长相、罩杯、学历、性格（九型匹配度）、家庭环境。
*   **分值**：每项根据具体区间得 2.5 - 12.5 分不等。

### 6.2 九型人格匹配算法
*   **输入**：男方Top3人格，女方Top3人格。
*   **矩阵**：预设 9x9 匹配矩阵，定义每对组合的相性（+1:合适, 0:中性, -1:互斥）。
*   **计算**：
    1.  对候选人所有可能的人格组合进行遍历打分。
    2.  若出现任何 `-1` 分的组合，该候选人标记为“性格不合（不通过）”。
    3.  统计正向匹配得分。

---

## 7. 非功能性需求

*   **数据安全**：
    *   用户密码加密存储 (BCrypt)。
    *   敏感字段（手机号）在非授权视图（普通红娘）下自动脱敏（如 `138****0000`）。
    *   接口层必须校验 `token` 及 `store_id`，防止越权访问。
*   **性能要求**：
    *   支持 100+ 门店租户。
    *   单店 10W+ 数据量下的列表查询与匹配运算需在秒级响应。
*   **兼容性**：
    *   前台H5适配主流移动端浏览器及微信环境。
    *   后台适配 PC端 Chrome/Edge 浏览器。
*   **部署**：
    *   数据库：MySQL。
    *   服务器：腾讯云。
    *   文件存储：OSS（用于大头照等图片存储）。

## 8. 页面规划

### 8.1 前台 (Mobile H5)
1.  **首页 (Landing Page)**：
    *   **无需登录**。
    *   展示项目Slogan、核心价值介绍、机构背景。
    *   **CTA按钮（立即进入）**：点击判断用户状态，未登录跳登录页，已登录跳测评中心。
2.  **登录/注册页**：手机号验证、信息填写表单。
3.  **测评中心**：
    *   **需登录访问**。
    *   展示三大测评卡片（九型、依恋、幸福力），显示完成状态。
    *   **个人中心入口**：位于页面右上角。
4.  **答题页**：单题展示、进度条、上一题/下一题。
5.  **结果页**：图表展示（柱状图/圆环图）、文本解读、重新测试入口。
6.  **个人中心**：查看档案、历史测评记录（带状态标签）。

### 8.2 后台 (PC Web)
1.  **登录页**：账号密码登录。
2.  **主布局**：左侧菜单栏 + 右侧内容区。
3.  **人员管理**：
    *   人员审核（列表+操作）
    *   人员列表（增删改查）
4.  **角色&门店管理**：
    *   角色列表（权限查看）
    *   门店列表（新增门店、绑定MV方案）
5.  **用户档案管理**：
    *   用户列表（搜索、筛选、跳转详情）
    *   用户详情页（档案编辑、三大轨迹记录）
    *   智能匹配（发起匹配弹窗、匹配结果列表、历史批次查询）

