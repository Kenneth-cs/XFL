# 手机号脱敏与红娘分配功能说明

## 📋 功能概述

本文档说明已实现的两个重要权限控制功能：
1. **手机号脱敏**：普通红娘查看会员资料时，手机号自动脱敏显示
2. **红娘分配权限**：只有门店负责人及以上角色才能分配/更改服务红娘

---

## 1️⃣ 手机号脱敏功能

### 功能需求（来源：PRD 第48行）

> **后台-普通红娘**：查看/编辑本门店**自己服务**的会员资料、发起匹配、记录服务轨迹
> **关键限制**：**手机号脱敏**，不可见服务会员手机号详情

### 实现逻辑

**脱敏规则**：
- 原始手机号：`13812345678`
- 脱敏后显示：`138****5678`
- **规则**：保留前3位和后4位，中间4位用 `****` 替换

**权限判断**：
- ✅ **普通红娘 (matchmaker)**：手机号自动脱敏
- ✅ **门店负责人 (manager)**：显示完整手机号
- ✅ **门店老板 (admin)**：显示完整手机号
- ✅ **超级管理员 (super_admin)**：显示完整手机号

### 涉及接口

| 接口 | 方法 | 功能 | 脱敏位置 |
|------|------|------|---------|
| `/api/v1/users/app` | GET | 获取前台用户列表 | ✅ 已实现 |
| `/api/v1/users/profile/:userId` | GET | 获取用户档案详情 | ✅ 已实现 |

### 代码实现

**工具函数**：`backend/src/shared/utils/phone.util.ts`
```typescript
export function maskPhone(phone: string): string {
  return phone.substring(0, 3) + '****' + phone.substring(7);
}
```

**Service层**：`backend/src/modules/user/user.service.ts`
```typescript
// 获取用户列表
async findAllAppUsers(..., currentUser: CurrentUserData) {
  // ...查询逻辑
  
  // 手机号脱敏：普通红娘看不到完整手机号
  const shouldMask = currentUser?.role === SysUserRole.MATCHMAKER;
  const maskedUsers = maskUsersPhone(users, shouldMask);
  
  return { data: maskedUsers, total, page, limit };
}

// 获取用户档案
async getUserProfile(userId: string, currentUser: CurrentUserData) {
  // ...查询逻辑
  
  // 手机号脱敏：普通红娘看不到完整手机号
  if (currentUser?.role === SysUserRole.MATCHMAKER && profile.user?.phone) {
    profile.user.phone = maskPhone(profile.user.phone);
  }
  
  return profile;
}
```

---

## 2️⃣ 红娘分配权限控制

### 功能需求（来源：需求文档 第185行）

> **门店负责人**：
> 1. 标识后台用户—普通红娘可服务客户。
> 2. 例如：前台用户新增注册后，后台显示的基本信息中，有一项**服务红娘**的字段，由门店负责人负责维护，普通红娘只能查看。
> 3. 若普通红娘对客户服务不足，导致需要更换服务红娘，更换只能由门店负责人更换。（字段仅限于展示功能）

### 实现逻辑

**权限判断**：
- ✅ **超级管理员 (super_admin)**：可以分配服务红娘
- ✅ **门店老板 (admin)**：可以分配服务红娘
- ✅ **门店负责人 (manager)**：可以分配服务红娘
- ❌ **普通红娘 (matchmaker)**：**不能**分配服务红娘（只读）

### 涉及接口

| 接口 | 方法 | 功能 | 权限校验 |
|------|------|------|---------|
| `/api/v1/users/profile/:userId` | PATCH | 更新用户档案 | ✅ 已实现 |

**请求体示例**：
```json
{
  "serviceMatchmakerId": "XFL001G00001",  // 要分配的红娘ID
  "baseInfo": { ... },                    // 基础信息（所有角色可修改）
  "extInfo": { ... }                      // 扩展信息（所有角色可修改）
}
```

### 代码实现

**Service层**：`backend/src/modules/user/user.service.ts`
```typescript
async updateUserProfile(userId: string, updateDto: any, currentUser: CurrentUserData) {
  // 权限校验：分配服务红娘只能由门店负责人及以上角色操作
  if (updateDto.serviceMatchmakerId !== undefined) {
    const canAssignMatchmaker = 
      currentUser.role === SysUserRole.SUPER_ADMIN ||
      currentUser.role === SysUserRole.ADMIN ||
      currentUser.role === SysUserRole.MANAGER;

    if (!canAssignMatchmaker) {
      throw new ForbiddenException('只有门店负责人及以上角色才能分配服务红娘');
    }

    profile.serviceMatchmakerId = updateDto.serviceMatchmakerId;
  }
  
  // ... 其他字段更新
}
```

---

## 🧪 测试说明

### 测试场景1：手机号脱敏测试

**步骤**：
1. 使用普通红娘账号登录后台
2. 进入"用户列表"页面
3. 查看任意用户的手机号

**预期结果**：
- ✅ 手机号显示为 `138****5678` 格式
- ✅ 切换到负责人/老板账号，显示完整手机号 `13812345678`

**API测试**：
```bash
# 普通红娘登录后
GET /api/v1/users/app
Authorization: Bearer {红娘Token}

# 返回：
{
  "data": [
    {
      "id": "XFL00100001",
      "phone": "138****5678",  // ✅ 脱敏
      ...
    }
  ]
}

# 负责人登录后
GET /api/v1/users/app
Authorization: Bearer {负责人Token}

# 返回：
{
  "data": [
    {
      "id": "XFL00100001",
      "phone": "13812345678",  // ✅ 完整
      ...
    }
  ]
}
```

### 测试场景2：红娘分配权限测试

**步骤**：
1. 使用普通红娘账号登录后台
2. 尝试修改某会员的"服务红娘"字段

**预期结果**：
- ❌ 返回 `403 Forbidden`
- ❌ 提示：`只有门店负责人及以上角色才能分配服务红娘`

**步骤**：
1. 使用门店负责人账号登录后台
2. 修改某会员的"服务红娘"字段

**预期结果**：
- ✅ 修改成功
- ✅ 返回更新后的档案信息

**API测试**：
```bash
# 普通红娘尝试分配
PATCH /api/v1/users/profile/XFL00100001
Authorization: Bearer {红娘Token}
Content-Type: application/json

{
  "serviceMatchmakerId": "XFL001G00002"
}

# 返回：
{
  "statusCode": 403,
  "message": "只有门店负责人及以上角色才能分配服务红娘"
}

# 门店负责人分配
PATCH /api/v1/users/profile/XFL00100001
Authorization: Bearer {负责人Token}
Content-Type: application/json

{
  "serviceMatchmakerId": "XFL001G00002"
}

# 返回：
{
  "userId": "XFL00100001",
  "serviceMatchmakerId": "XFL001G00002",  // ✅ 更新成功
  ...
}
```

---

## ✅ 验收标准

### 手机号脱敏
- [x] 普通红娘查看用户列表时，手机号显示为 `138****5678`
- [x] 普通红娘查看用户档案详情时，手机号显示为 `138****5678`
- [x] 负责人/老板/超管查看时，显示完整手机号
- [x] 脱敏逻辑在后端实现，前端无法绕过

### 红娘分配权限
- [x] 普通红娘尝试修改 `serviceMatchmakerId` 时返回 403
- [x] 负责人/老板/超管可以成功修改 `serviceMatchmakerId`
- [x] 普通红娘仍可修改其他字段（如 `baseInfo`, `extInfo`）
- [x] 权限校验在后端实现，前端无法绕过

---

## 📝 注意事项

1. **数据安全**：
   - 手机号脱敏在后端 Service 层实现，确保 API 返回的数据已脱敏
   - 前端无法通过任何方式获取到完整手机号（如果当前角色是红娘）

2. **向后兼容**：
   - 如果 `currentUser` 参数为空，默认不进行脱敏（兼容旧代码）
   - 如果 `updateDto` 中不包含 `serviceMatchmakerId`，则不进行权限校验

3. **前端展示**（待开发）：
   - 建议在前端用户列表中，为普通红娘角色隐藏"分配红娘"按钮
   - 建议在前端档案编辑表单中，为普通红娘角色将"服务红娘"字段设为只读

---

**文档版本**：v1.0  
**实现日期**：2026-01-14  
**开发人员**：AI Assistant

