# 新服务器部署指南

**新服务器IP：** 124.222.88.25  
**旧服务器IP：** 115.159.58.73

## 第一步：从旧服务器备份数据

### 1.1 登录旧服务器备份数据库

```bash
# 登录旧服务器
ssh root@115.159.58.73

# 备份数据库
mysqldump -u root -p xinfu_db > /root/xinfu_db_backup_$(date +%Y%m%d).sql

# 查看备份文件
ls -lh /root/*.sql

# 退出旧服务器
exit
```

### 1.2 下载备份到本地

```bash
# 在本地执行，下载数据库备份
scp root@115.159.58.73:/root/xinfu_db_backup_*.sql ~/Desktop/
```

## 第二步：准备部署包

### 2.1 打包最新代码

```bash
cd /Users/cs/Desktop/CS/创业/相亲项目开发/幸福力项目开发

# 打包后端
cd backend
npm run build
cd ..

# 打包前端管理系统
cd frontend-admin
npx vite build --mode production
cd ..

# 打包前端H5
cd frontend-h5
npx vite build --mode production
cd ..

# 创建完整部署包
tar -czf xinfu-deploy-$(date +%Y%m%d).tar.gz \
  backend/dist \
  backend/package*.json \
  backend/.env.production.example \
  frontend-admin/dist \
  frontend-h5/dist \
  database/*.sql

echo "✅ 部署包已创建：xinfu-deploy-$(date +%Y%m%d).tar.gz"
```

### 2.2 上传到新服务器

```bash
# 上传部署包
scp xinfu-deploy-*.tar.gz root@124.222.88.25:/tmp/

# 上传数据库备份
scp ~/Desktop/xinfu_db_backup_*.sql root@124.222.88.25:/tmp/
```

## 第三步：新服务器环境准备

### 3.1 登录新服务器

```bash
ssh root@124.222.88.25
```

### 3.2 安装必要软件

```bash
# 更新系统
yum update -y

# 安装 Node.js 20.x
curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
yum install -y nodejs

# 验证安装
node -v
npm -v

# 安装 PM2
npm install -g pm2

# 安装 MySQL 8.0
wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
rpm -ivh mysql80-community-release-el7-3.noarch.rpm
yum install -y mysql-server

# 启动 MySQL
systemctl start mysqld
systemctl enable mysqld

# 获取临时密码
grep 'temporary password' /var/log/mysqld.log

# 安装 Nginx
yum install -y nginx

# 启动 Nginx
systemctl start nginx
systemctl enable nginx

# 安装 Redis
yum install -y redis
systemctl start redis
systemctl enable redis
```

### 3.3 配置 MySQL

```bash
# 修改 root 密码（需要先用临时密码登录）
mysql -u root -p

# 在 MySQL 中执行
ALTER USER 'root'@'localhost' IDENTIFIED BY 'YourStrongPassword123!';
FLUSH PRIVILEGES;

# 创建数据库和用户
CREATE DATABASE IF NOT EXISTS xinfu_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS 'xinfu_user'@'localhost' IDENTIFIED BY 'Xinfu2026Pass!';
GRANT ALL PRIVILEGES ON xinfu_db.* TO 'xinfu_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 3.4 导入数据库

```bash
# 如果有旧服务器的备份
mysql -u root -p xinfu_db < /tmp/xinfu_db_backup_*.sql

# 如果没有备份，导入初始SQL
mysql -u root -p xinfu_db < /www/projects/xinfu-project/database/02_create_tables.sql
mysql -u root -p xinfu_db < /www/projects/xinfu-project/database/04_assessment_tables.sql
mysql -u root -p xinfu_db < /www/projects/xinfu-project/database/06_match_tables.sql
# ... 其他必要的SQL文件
```

## 第四步：部署项目

### 4.1 创建项目目录

```bash
mkdir -p /www/projects/xinfu-project
mkdir -p /www/wwwroot/admin
mkdir -p /www/wwwroot/h5
cd /www/projects/xinfu-project
```

### 4.2 解压部署包

```bash
tar -xzf /tmp/xinfu-deploy-*.tar.gz -C /www/projects/xinfu-project
```

### 4.3 配置后端环境变量

```bash
cat > /www/projects/xinfu-project/backend/.env << 'EOF'
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=xinfu_user
DB_PASSWORD=Xinfu2026Pass!
DB_DATABASE=xinfu_db

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379

# JWT 配置
JWT_SECRET=your-super-secret-jwt-key-change-in-production

# 端口配置
PORT=3001

# 环境
NODE_ENV=production
EOF
```

### 4.4 安装后端依赖

```bash
cd /www/projects/xinfu-project/backend
npm install --production
```

### 4.5 配置 PM2

```bash
cat > /www/projects/xinfu-project/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'xinfu-backend',
    script: './backend/dist/main.js',
    cwd: '/www/projects/xinfu-project',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    error_file: '/www/logs/xinfu-backend-error.log',
    out_file: '/www/logs/xinfu-backend-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss'
  }]
}
EOF

# 创建日志目录
mkdir -p /www/logs

# 启动后端
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

### 4.6 部署前端

```bash
# 复制管理后台
cp -r /www/projects/xinfu-project/frontend-admin/dist/* /www/wwwroot/admin/

# 复制H5前端
cp -r /www/projects/xinfu-project/frontend-h5/dist/* /www/wwwroot/h5/
```

### 4.7 配置 Nginx

```bash
cat > /etc/nginx/conf.d/xinfu.conf << 'EOF'
# 管理后台
server {
    listen 80;
    server_name 124.222.88.25;
    
    # 管理后台
    location /admin/ {
        alias /www/wwwroot/admin/;
        try_files $uri $uri/ /admin/index.html;
        index index.html;
    }
    
    # H5前端
    location /h5/ {
        alias /www/wwwroot/h5/;
        try_files $uri $uri/ /h5/index.html;
        index index.html;
    }
    
    # 后端API
    location /api/ {
        proxy_pass http://127.0.0.1:3001/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
EOF

# 测试配置
nginx -t

# 重启 Nginx
nginx -s reload
```

### 4.8 配置防火墙

```bash
# 如果使用 firewalld
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload

# 或者直接开放端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --reload
```

## 第五步：验证部署

### 5.1 检查服务状态

```bash
# 检查后端
pm2 status
pm2 logs xinfu-backend --lines 50

# 检查 Nginx
systemctl status nginx

# 检查 MySQL
systemctl status mysqld

# 检查端口
netstat -tlnp | grep -E '3001|80'
```

### 5.2 测试访问

在浏览器中访问：

- **管理后台：** http://124.222.88.25/admin/
- **H5前端：** http://124.222.88.25/h5/
- **API测试：** http://124.222.88.25/api/v1/health

### 5.3 测试数据库连接

```bash
# 在服务器上执行
mysql -u xinfu_user -p -e "USE xinfu_db; SHOW TABLES;"
```

## 第六步：数据验证

### 6.1 检查数据完整性

```bash
# 检查用户数据
mysql -u xinfu_user -p -e "SELECT COUNT(*) FROM xinfu_db.app_user;"

# 检查门店数据
mysql -u xinfu_user -p -e "SELECT COUNT(*) FROM xinfu_db.store;"

# 检查测评数据
mysql -u xinfu_user -p -e "SELECT COUNT(*) FROM xinfu_db.enneagram_result;"
```

### 6.2 登录测试

1. 访问管理后台：http://124.222.88.25/admin/
2. 使用超级管理员账号登录
3. 检查各功能模块是否正常

## 第七步：配置域名（可选）

如果有域名，可以配置域名访问：

```bash
# 修改 Nginx 配置
vim /etc/nginx/conf.d/xinfu.conf

# 修改 server_name
server_name your-domain.com www.your-domain.com;

# 重启 Nginx
nginx -s reload
```

## 常见问题排查

### 问题1：后端无法启动

```bash
# 查看日志
pm2 logs xinfu-backend --lines 100

# 检查环境变量
cat /www/projects/xinfu-project/backend/.env

# 检查数据库连接
mysql -u xinfu_user -p -e "SELECT 1;"
```

### 问题2：前端404

```bash
# 检查文件是否存在
ls -la /www/wwwroot/admin/
ls -la /www/wwwroot/h5/

# 检查 Nginx 配置
nginx -t
cat /etc/nginx/conf.d/xinfu.conf
```

### 问题3：API请求失败

```bash
# 检查后端是否运行
pm2 status

# 检查端口
netstat -tlnp | grep 3001

# 检查 Nginx 代理配置
curl http://127.0.0.1:3001/api/v1/health
```

## 安全加固（建议）

### 1. 配置 HTTPS

```bash
# 安装 Certbot
yum install -y certbot python3-certbot-nginx

# 获取证书
certbot --nginx -d your-domain.com -d www.your-domain.com

# 自动续期
echo "0 0 * * * certbot renew --quiet" | crontab -
```

### 2. 配置防火墙

```bash
# 只允许必要端口
firewall-cmd --permanent --remove-service=ssh
firewall-cmd --permanent --add-port=22/tcp --add-source=your-ip
firewall-cmd --reload
```

### 3. 定期备份

```bash
# 创建备份脚本
cat > /root/backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup"
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u root -p'YourPassword' xinfu_db > $BACKUP_DIR/xinfu_db_$DATE.sql

# 备份代码
tar -czf $BACKUP_DIR/xinfu_project_$DATE.tar.gz /www/projects/xinfu-project

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "Backup completed: $DATE"
EOF

chmod +x /root/backup.sh

# 设置定时任务（每天凌晨3点）
echo "0 3 * * * /root/backup.sh >> /var/log/backup.log 2>&1" | crontab -
```

## 完成检查清单

- [ ] 系统环境安装完成（Node.js, MySQL, Nginx, PM2, Redis）
- [ ] 数据库创建并导入数据
- [ ] 后端部署并正常运行
- [ ] 前端部署并可以访问
- [ ] API 接口测试通过
- [ ] 管理后台登录成功
- [ ] H5前端功能正常
- [ ] 数据完整性验证通过
- [ ] 防火墙配置完成
- [ ] 备份策略设置完成

## 联系方式

如有问题，请参考：
- 项目文档：`/项目核心文档/`
- 部署文档：`/deployment/`
- 启动指南：`/快速启动指南.md`
