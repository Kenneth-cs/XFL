# å¿«é€Ÿå‚è€ƒï¼šè·¯å¾„é…ç½®ä¸å¸¸è§é—®é¢˜

> ç²¾ç®€ç‰ˆå‚è€ƒæ‰‹å†Œï¼Œå¿«é€Ÿè§£å†³éƒ¨ç½²ä¸­çš„è·¯å¾„é—®é¢˜

## ğŸ¯ æ ¸å¿ƒé…ç½®æ¸…å•

### 1. Viteé…ç½®ï¼ˆæœ€é‡è¦ï¼ï¼‰

**frontend-h5/vite.config.ts**
```typescript
export default defineConfig({
  base: '/h5/',  // â­ å¿…é¡»é…ç½®ï¼
  // ... å…¶ä»–é…ç½®
})
```

**frontend-admin/vite.config.ts**
```typescript
export default defineConfig({
  base: '/admin/',  // â­ å¿…é¡»é…ç½®ï¼
  // ... å…¶ä»–é…ç½®
})
```

### 2. Nginxé…ç½®

```nginx
server {
    listen 8080;
    
    # H5å‰å°
    location = /h5 {
        return 301 /h5/;  # é‡å®šå‘ï¼Œæ·»åŠ æ–œæ 
    }
    location /h5/ {
        alias /www/projects/xinfu-project/frontend-h5/dist/;  # æ³¨æ„æœ«å°¾æ–œæ ï¼
        try_files $uri $uri/ /h5/index.html;
    }
    
    # Adminåå°
    location = /admin {
        return 301 /admin/;
    }
    location /admin/ {
        alias /www/projects/xinfu-project/frontend-admin/dist/;
        try_files $uri $uri/ /admin/index.html;
    }
    
    # API
    location /api {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. åç«¯é…ç½®

**backend/.env**
```env
DB_HOST=localhost
DB_USERNAME=root
DB_PASSWORD=your_password
DB_DATABASE=xinfu_db
PORT=3001
NODE_ENV=production
JWT_SECRET=your_secret_key
```

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤

### å‰ç«¯éƒ¨ç½²

```bash
# 1. æœ¬åœ°æ„å»ºï¼ˆç¡®ä¿vite.config.tså·²é…ç½®baseè·¯å¾„ï¼‰
cd frontend-h5 && npx vite build && cd ..
cd frontend-admin && npx vite build && cd ..

# 2. éªŒè¯æ„å»ºç»“æœ
cat frontend-h5/dist/index.html | grep "assets"
# åº”è¾“å‡ºï¼š/h5/assets/index-xxx.js

cat frontend-admin/dist/index.html | grep "assets"
# åº”è¾“å‡ºï¼š/admin/assets/index-xxx.js

# 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -i ~/.ssh/XFL.pem -r frontend-h5/dist ubuntu@SERVER_IP:/tmp/h5-dist
scp -i ~/.ssh/XFL.pem -r frontend-admin/dist ubuntu@SERVER_IP:/tmp/admin-dist

# 4. éƒ¨ç½²ï¼ˆæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰
ssh -i ~/.ssh/XFL.pem ubuntu@SERVER_IP
sudo rm -rf /www/projects/xinfu-project/frontend-h5/dist
sudo rm -rf /www/projects/xinfu-project/frontend-admin/dist
sudo mv /tmp/h5-dist /www/projects/xinfu-project/frontend-h5/dist
sudo mv /tmp/admin-dist /www/projects/xinfu-project/frontend-admin/dist
sudo chown -R www-data:www-data /www/projects/xinfu-project/frontend-*/dist
sudo systemctl restart nginx
```

### åç«¯éƒ¨ç½²

```bash
# 1. æœ¬åœ°æ„å»º
cd backend && npm run build && cd ..

# 2. ä¸Šä¼ 
scp -i ~/.ssh/XFL.pem -r backend/dist ubuntu@SERVER_IP:/tmp/backend-dist

# 3. éƒ¨ç½²ï¼ˆæœåŠ¡å™¨ä¸Šï¼‰
ssh -i ~/.ssh/XFL.pem ubuntu@SERVER_IP
rm -rf /www/projects/xinfu-project/backend/dist
mv /tmp/backend-dist /www/projects/xinfu-project/backend/dist
pm2 restart xinfu-backend
pm2 logs xinfu-backend --lines 20
```

---

## âŒ å¸¸è§é”™è¯¯ä¸å¿«é€Ÿä¿®å¤

### é”™è¯¯1ï¼šé¡µé¢ç©ºç™½ï¼Œæ§åˆ¶å°404

**ç—‡çŠ¶ï¼š**
```
Failed to load resource: http://server/assets/index.js 404
```

**åŸå› ï¼š** Viteé…ç½®ç¼ºå°‘ `base` è·¯å¾„

**ä¿®å¤ï¼š**
```typescript
// vite.config.ts
export default defineConfig({
  base: '/h5/',  // æ·»åŠ è¿™è¡Œï¼
})
```

ç„¶åé‡æ–°æ„å»ºï¼š
```bash
npx vite build
```

### é”™è¯¯2ï¼šæµè§ˆå™¨ç¼“å­˜æ—§æ–‡ä»¶

**ç—‡çŠ¶ï¼š** æ˜æ˜æ›´æ–°äº†ï¼Œä½†è¿˜æ˜¯æ˜¾ç¤ºæ—§å†…å®¹

**ä¿®å¤ï¼š**
1. æŒ‰ `Ctrl + Shift + R`ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰
2. æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼è®¿é—®
3. æˆ–åœ¨Nginxæ·»åŠ ç¦ç”¨ç¼“å­˜ï¼š
```nginx
add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
```

### é”™è¯¯3ï¼šH5åŠ è½½Adminçš„èµ„æº

**ç—‡çŠ¶ï¼š**
```
Failed to load: http://server/admin/assets/index.js
```
ä½†å½“å‰åœ¨H5é¡µé¢

**åŸå› ï¼š** ä¸Šä¼ æ—¶æ–‡ä»¶æ”¾é”™äº†ä½ç½®ï¼Œæˆ–Nginxé…ç½®é”™è¯¯

**ä¿®å¤ï¼š**
```bash
# æ£€æŸ¥æœåŠ¡å™¨æ–‡ä»¶
cat /www/projects/xinfu-project/frontend-h5/dist/index.html
# åº”è¯¥åŒ…å« /h5/assets/

# å¦‚æœä¸å¯¹ï¼Œé‡æ–°ä¸Šä¼ æ­£ç¡®çš„æ–‡ä»¶
```

### é”™è¯¯4ï¼šåç«¯æ— æ³•å¯åŠ¨

**ç—‡çŠ¶ï¼š**
```
Error: Script not found: /path/to/main.js
```

**ä¿®å¤ï¼š**
```bash
# é‡æ–°æ„å»ºåç«¯
cd /www/projects/xinfu-project/backend
npm run build
pm2 restart xinfu-backend
```

### é”™è¯¯5ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
Access denied for user 'root'@'localhost'
```

**ä¿®å¤ï¼š**
```sql
-- ç™»å½•MySQL
sudo mysql -u root

-- ä¿®æ”¹è®¤è¯æ–¹å¼
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'your_password';
FLUSH PRIVILEGES;
```

ç„¶åæ›´æ–° `backend/.env` çš„å¯†ç ï¼Œé‡å¯åç«¯ï¼š
```bash
pm2 restart xinfu-backend
```

---

## ğŸ” å¿«é€Ÿè¯Šæ–­å‘½ä»¤

### æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ‰€æœ‰æœåŠ¡
pm2 status
sudo systemctl status nginx mysql redis-server

# ç«¯å£å ç”¨
sudo netstat -tlnp | grep -E '3001|3306|6379|8080'
```

### æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®
```bash
# H5æ„å»ºäº§ç‰©
cat /www/projects/xinfu-project/frontend-h5/dist/index.html | grep "src="
# åº”è¾“å‡ºï¼š/h5/assets/index-xxx.js

# Adminæ„å»ºäº§ç‰©
cat /www/projects/xinfu-project/frontend-admin/dist/index.html | grep "src="
# åº”è¾“å‡ºï¼š/admin/assets/index-xxx.js

# åç«¯æ„å»ºäº§ç‰©
ls -lh /www/projects/xinfu-project/backend/dist/main.js
```

### æŸ¥çœ‹æ—¥å¿—
```bash
# åç«¯æ—¥å¿—
pm2 logs xinfu-backend --lines 50

# Nginxé”™è¯¯æ—¥å¿—
sudo tail -n 50 /var/log/nginx/error.log

# å®æ—¶ç›‘æ§
pm2 monit
```

---

## ğŸ“ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰å¿…é¡»å®Œæˆï¼š

- [ ] âœ… `frontend-h5/vite.config.ts` å·²é…ç½® `base: '/h5/'`
- [ ] âœ… `frontend-admin/vite.config.ts` å·²é…ç½® `base: '/admin/'`
- [ ] âœ… æœ¬åœ°æ„å»ºæˆåŠŸï¼ˆ`npm run build`ï¼‰
- [ ] âœ… éªŒè¯HTMLä¸­çš„èµ„æºè·¯å¾„æ­£ç¡®ï¼ˆ`cat dist/index.html`ï¼‰
- [ ] âœ… `backend/.env` é…ç½®æ­£ç¡®ï¼ˆæ•°æ®åº“å¯†ç ã€JWTå¯†é’¥ç­‰ï¼‰
- [ ] âœ… åç«¯æ„å»ºæˆåŠŸï¼ˆ`npm run build`ï¼Œæ£€æŸ¥ `dist/main.js` å­˜åœ¨ï¼‰
- [ ] âœ… Nginxé…ç½®æ­£ç¡®ï¼ˆ`sudo nginx -t`ï¼‰

---

## ğŸ¯ è®¿é—®åœ°å€

éƒ¨ç½²å®Œæˆåè®¿é—®ï¼š

- **H5å‰å°ï¼š** `http://YOUR_SERVER_IP:8080/h5/` ï¼ˆæœ«å°¾å¿…é¡»å¸¦ `/`ï¼‰
- **Adminåå°ï¼š** `http://YOUR_SERVER_IP:8080/admin/` ï¼ˆæœ«å°¾å¿…é¡»å¸¦ `/`ï¼‰

---

## ğŸ“ å¿«é€Ÿæ”¯æŒ

é‡åˆ°é—®é¢˜æ—¶ï¼š

1. **å…ˆæŸ¥çœ‹æ—¥å¿—ï¼š** `pm2 logs` å’Œ `sudo tail /var/log/nginx/error.log`
2. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼š** æŒ‰ `F12` æŸ¥çœ‹Consoleå’ŒNetworké¢æ¿
3. **ç¡®è®¤æ–‡ä»¶è·¯å¾„ï¼š** ç”¨ `cat` å‘½ä»¤æ£€æŸ¥HTMLæ–‡ä»¶å†…å®¹
4. **å°è¯•ç¡¬åˆ·æ–°ï¼š** `Ctrl + Shift + R`

---

**ç‰ˆæœ¬ï¼š** v1.0  
**æ›´æ–°ï¼š** 2026-01-28
