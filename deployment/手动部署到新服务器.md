# 手动部署到新服务器指南

**新服务器IP：** 124.222.88.25  
**已准备文件：**
- ✅ 部署包：`xinfu-deploy-20260127_232616.tar.gz`
- ✅ 数据库备份：`xinfu_db_backup_20260123.sql`

---

## 第一步：上传文件到新服务器

在本地终端执行（会提示输入密码）：

```bash
cd /Users/cs/Desktop/CS/创业/相亲项目开发/幸福力项目开发

# 上传部署包
scp xinfu-deploy-20260127_232616.tar.gz root@124.222.88.25:/tmp/

# 上传数据库备份
scp xinfu_db_backup_20260123.sql root@124.222.88.25:/tmp/
```

**提示：** 每次执行会要求输入新服务器的密码。

---

## 第二步：登录新服务器

```bash
ssh root@124.222.88.25
```

输入密码后登录。

---

## 第三步：在新服务器上执行部署

### 3.1 安装基础环境

```bash
# 更新系统
yum update -y

# 安装 Node.js 20.x
curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
yum install -y nodejs

# 验证安装
node -v  # 应该显示 v20.x.x
npm -v

# 安装 PM2
npm install -g pm2

# 安装 MySQL 8.0
wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
rpm -ivh mysql80-community-release-el7-3.noarch.rpm
yum install -y mysql-server

# 启动 MySQL
systemctl start mysqld
systemctl enable mysqld

# 获取MySQL临时密码（记下来）
grep 'temporary password' /var/log/mysqld.log

# 安装 Nginx
yum install -y nginx
systemctl start nginx
systemctl enable nginx

# 安装 Redis
yum install -y redis
systemctl start redis
systemctl enable redis
```

### 3.2 配置 MySQL

```bash
# 用临时密码登录 MySQL
mysql -u root -p
```

在 MySQL 中执行以下SQL：

```sql
-- 修改 root 密码（请替换成你自己的强密码）
ALTER USER 'root'@'localhost' IDENTIFIED BY 'YourStrongPassword123!';
FLUSH PRIVILEGES;

-- 创建数据库和用户
CREATE DATABASE IF NOT EXISTS xinfu_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS 'xinfu_user'@'localhost' IDENTIFIED BY 'Xinfu2026Pass!';
GRANT ALL PRIVILEGES ON xinfu_db.* TO 'xinfu_user'@'localhost';
FLUSH PRIVILEGES;

EXIT;
```

### 3.3 导入数据库

```bash
# 导入数据库备份（用 root 密码）
mysql -u root -p xinfu_db < /tmp/xinfu_db_backup_20260123.sql

# 验证导入
mysql -u xinfu_user -pXinfu2026Pass! -e "USE xinfu_db; SHOW TABLES;"
```

### 3.4 部署项目

```bash
# 创建目录
mkdir -p /www/projects/xinfu-project
mkdir -p /www/wwwroot/admin
mkdir -p /www/wwwroot/h5
mkdir -p /www/logs

# 解压部署包
cd /www/projects/xinfu-project
tar -xzf /tmp/xinfu-deploy-20260127_232616.tar.gz

# 配置后端环境变量
cat > backend/.env << 'EOF'
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=xinfu_user
DB_PASSWORD=Xinfu2026Pass!
DB_DATABASE=xinfu_db

REDIS_HOST=localhost
REDIS_PORT=6379

JWT_SECRET=your-super-secret-jwt-key-change-this-in-production-2026

PORT=3001
NODE_ENV=production
EOF

# 安装后端依赖
cd backend
npm install --production

# 配置 PM2
cd /www/projects/xinfu-project
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'xinfu-backend',
    script: './backend/dist/main.js',
    cwd: '/www/projects/xinfu-project',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    error_file: '/www/logs/xinfu-backend-error.log',
    out_file: '/www/logs/xinfu-backend-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss'
  }]
}
EOF

# 启动后端
pm2 start ecosystem.config.js
pm2 save
pm2 startup

# 查看后端状态
pm2 status
pm2 logs xinfu-backend --lines 20
```

### 3.5 部署前端

```bash
# 复制前端文件
cp -r /www/projects/xinfu-project/frontend-admin/dist/* /www/wwwroot/admin/
cp -r /www/projects/xinfu-project/frontend-h5/dist/* /www/wwwroot/h5/

# 验证文件
ls -la /www/wwwroot/admin/
ls -la /www/wwwroot/h5/
```

### 3.6 配置 Nginx

```bash
# 备份原配置（如果存在）
mv /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak 2>/dev/null || true

# 创建新配置
cat > /etc/nginx/conf.d/xinfu.conf << 'EOF'
server {
    listen 80;
    server_name _;
    
    # 管理后台
    location /admin/ {
        alias /www/wwwroot/admin/;
        try_files $uri $uri/ /admin/index.html;
        index index.html;
    }
    
    # H5前端
    location /h5/ {
        alias /www/wwwroot/h5/;
        try_files $uri $uri/ /h5/index.html;
        index index.html;
    }
    
    # 后端API
    location /api/ {
        proxy_pass http://127.0.0.1:3001/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
EOF

# 测试配置
nginx -t

# 重启 Nginx
nginx -s reload
```

### 3.7 配置防火墙

```bash
# 开放HTTP端口
firewall-cmd --permanent --add-service=http
firewall-cmd --reload

# 或者直接开放端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --reload
```

---

## 第四步：验证部署

### 4.1 检查服务状态

```bash
# 检查后端
pm2 status
pm2 logs xinfu-backend --lines 50

# 检查 Nginx
systemctl status nginx

# 检查端口
netstat -tlnp | grep -E '3001|80'
```

### 4.2 访问测试

在浏览器中访问：

- **管理后台：** http://124.222.88.25/admin/
- **H5前端：** http://124.222.88.25/h5/
- **API健康检查：** http://124.222.88.25/api/v1/health

### 4.3 测试登录

**超级管理员账号：**
- 用户名：`super_admin`
- 密码：`admin123456`

**普通管理员账号：**
- 用户名：`admin`
- 密码：`123456`

---

## 常见问题排查

### 问题1：后端无法启动

```bash
# 查看详细日志
pm2 logs xinfu-backend --lines 100

# 检查环境变量
cat /www/projects/xinfu-project/backend/.env

# 测试数据库连接
mysql -u xinfu_user -pXinfu2026Pass! -e "SELECT 1;"

# 重启后端
pm2 restart xinfu-backend
```

### 问题2：前端404

```bash
# 检查文件是否存在
ls -la /www/wwwroot/admin/index.html
ls -la /www/wwwroot/h5/index.html

# 检查 Nginx 配置
nginx -t
cat /etc/nginx/conf.d/xinfu.conf

# 重启 Nginx
nginx -s reload
```

### 问题3：API 502/504错误

```bash
# 确认后端运行
pm2 status

# 确认端口监听
netstat -tlnp | grep 3001

# 测试本地API
curl http://127.0.0.1:3001/api/v1/health

# 查看 Nginx 错误日志
tail -f /var/log/nginx/error.log
```

### 问题4：数据库连接失败

```bash
# 测试数据库连接
mysql -u xinfu_user -pXinfu2026Pass! xinfu_db -e "SHOW TABLES;"

# 检查 MySQL 状态
systemctl status mysqld

# 查看 MySQL 错误日志
tail -f /var/log/mysqld.log
```

---

## 部署完成检查清单

- [ ] MySQL 安装并运行正常
- [ ] 数据库 `xinfu_db` 已创建并导入数据
- [ ] Node.js 和 PM2 已安装
- [ ] 后端服务启动成功（`pm2 status` 显示 online）
- [ ] Nginx 安装并运行正常
- [ ] 前端文件已部署到 `/www/wwwroot/`
- [ ] 管理后台可以访问
- [ ] H5前端可以访问
- [ ] 可以正常登录管理后台
- [ ] 防火墙已开放80端口

---

## 下一步优化（可选）

### 1. 配置域名

如果有域名，修改 Nginx 配置：

```bash
vim /etc/nginx/conf.d/xinfu.conf
# 修改 server_name 为你的域名
# server_name your-domain.com;

nginx -s reload
```

### 2. 配置 HTTPS

```bash
# 安装 Certbot
yum install -y certbot python3-certbot-nginx

# 获取证书
certbot --nginx -d your-domain.com

# 自动续期
echo "0 0 * * * certbot renew --quiet" | crontab -
```

### 3. 设置定期备份

```bash
# 创建备份脚本
cat > /root/backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup"
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u root -pYourStrongPassword123! xinfu_db > $BACKUP_DIR/xinfu_db_$DATE.sql

# 压缩
gzip $BACKUP_DIR/xinfu_db_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: $DATE"
EOF

chmod +x /root/backup.sh

# 设置定时任务（每天凌晨3点）
echo "0 3 * * * /root/backup.sh >> /var/log/backup.log 2>&1" | crontab -
```

---

## 需要帮助？

如果遇到问题，请提供以下信息：

1. 错误日志：`pm2 logs xinfu-backend --lines 50`
2. Nginx 日志：`tail -100 /var/log/nginx/error.log`
3. 具体的错误提示或截图
