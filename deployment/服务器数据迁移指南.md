# 🚀 腾讯云服务器数据迁移指南

## 📋 迁移概述

本指南将帮助你安全地将幸福力项目从旧服务器迁移到新服务器，确保所有数据、配置和服务完整保留。

---

## 📊 迁移前检查清单

### 1. 确认需要迁移的内容
- ✅ MySQL数据库（用户数据、测评记录、匹配记录等）
- ✅ 项目代码（如有本地修改）
- ✅ 配置文件（.env、Nginx配置等）
- ✅ 上传的文件（如果有用户上传的头像、图片等）
- ✅ PM2配置和日志

### 2. 确认新服务器信息
- 新服务器IP: `待填写`
- SSH端口: `22`
- 操作系统: `CentOS/TencentOS（推荐与旧服务器一致）`

---

## 🎯 迁移方案（推荐）

### 方案A：数据库备份 + 代码重新部署（推荐）

**优点**: 干净、简单、不易出错
**适用**: 数据量不大（< 100MB），代码以Git仓库为准

#### 步骤概览
1. 旧服务器：备份MySQL数据库
2. 旧服务器：备份配置文件（可选）
3. 新服务器：按照《完整部署指南.md》全新部署
4. 新服务器：导入数据库备份
5. 验证服务运行

---

## 📝 详细操作步骤

### 第一步：在旧服务器上备份数据

#### 1.1 备份MySQL数据库

```bash
# SSH连接到旧服务器
ssh root@115.159.58.73

# 创建备份目录
mkdir -p /root/migration-backup
cd /root/migration-backup

# 备份整个数据库（推荐）
mysqldump -u root -p xinfu_db > xinfu_db_backup_$(date +%Y%m%d_%H%M%S).sql

# 或者分开备份（更安全，方便排查问题）
mysqldump -u root -p xinfu_db --no-data > xinfu_db_schema.sql  # 只导出表结构
mysqldump -u root -p xinfu_db --no-create-info > xinfu_db_data.sql  # 只导出数据

# 验证备份文件
ls -lh *.sql
# 应该看到备份文件，大小应该不为0
```

**说明**:
- 备份时会提示输入MySQL root密码
- 如果忘记密码，可以查看项目配置: `cat /www/projects/xinfu-project/backend/.env`

#### 1.2 备份项目配置文件（可选）

```bash
# 备份后端配置
cp /www/projects/xinfu-project/backend/.env.production xinfu_backend_env.backup
cp /www/projects/xinfu-project/backend/.env xinfu_backend_env_dev.backup 2>/dev/null || true

# 备份Nginx配置
cp /etc/nginx/conf.d/xinfu-project.conf xinfu_nginx.conf.backup

# 备份PM2配置
cp /www/projects/xinfu-project/ecosystem.config.js xinfu_pm2_config.backup

# 打包所有备份文件
tar -czf migration_backup_$(date +%Y%m%d).tar.gz *.sql *.backup *.conf.backup 2>/dev/null

# 验证打包文件
ls -lh migration_backup_*.tar.gz
```

#### 1.3 下载备份文件到本地

在**本地电脑**执行：

```bash
# 下载备份文件
scp root@115.159.58.73:/root/migration-backup/migration_backup_*.tar.gz ~/Desktop/

# 或者只下载SQL备份
scp root@115.159.58.73:/root/migration-backup/*.sql ~/Desktop/
```

**重要**: 请确保备份文件已成功下载到本地！

---

### 第二步：在新服务器上部署项目

#### 2.1 购买并配置新服务器

1. **腾讯云控制台操作**：
   - 购买新的云服务器（推荐配置：2核4G或以上）
   - 操作系统：CentOS 7.x 或 TencentOS Server 4
   - 记录新服务器的公网IP

2. **安全组配置**：
   - 开放端口：22（SSH）、8080（Nginx）、3306（MySQL，可选）
   - 建议：仅允许你的IP访问，或使用白名单

#### 2.2 配置SSH密钥（推荐）

在**本地电脑**执行：

```bash
cd "/Users/cs/Desktop/CS/创业/相亲项目开发/幸福力项目开发"

# 编辑setup-ssh-key.sh，输入新服务器IP
bash deployment/setup-ssh-key.sh

# 或手动配置
ssh-copy-id root@<新服务器IP>

# 测试连接
ssh root@<新服务器IP>
```

#### 2.3 全新部署项目

**参考文档**: `deployment/完整部署指南.md`

简化步骤：

**在本地电脑执行**：

```bash
cd "/Users/cs/Desktop/CS/创业/相亲项目开发/幸福力项目开发"

# 1. 打包项目（排除node_modules和备份文件）
tar --exclude='node_modules' \
    --exclude='.git' \
    --exclude='*.log' \
    --exclude='dist' \
    --exclude='deployment' \
    --exclude='*.tar.gz' \
    --exclude='migration-backup' \
    -czf xinfu-project.tar.gz \
    backend frontend-admin frontend-h5 database

# 2. 上传到新服务器
scp xinfu-project.tar.gz root@<新服务器IP>:/tmp/

# 3. 清理本地临时文件
rm xinfu-project.tar.gz
```

**在新服务器上执行**：

```bash
# SSH连接到新服务器
ssh root@<新服务器IP>

# 执行一键部署脚本（参考deployment/QUICK-START.md）
# 注意：修改脚本中的IP地址为新服务器IP

mkdir -p /www/projects/xinfu-project/{logs,database} && \
cd /www/projects/xinfu-project && \
tar -xzf /tmp/xinfu-project.tar.gz && \
rm /tmp/xinfu-project.tar.gz && \
echo "✅ 项目文件解压完成"

# ... 继续按照QUICK-START.md中的步骤执行
# （安装Nginx、配置数据库、构建项目等）
```

**关键点**：
- 在配置数据库步骤时，**暂时跳过导入SQL文件**
- 完成项目构建和Nginx配置
- 确保服务启动正常

---

### 第三步：导入数据库备份

#### 3.1 上传备份文件到新服务器

在**本地电脑**执行：

```bash
# 上传数据库备份
scp ~/Desktop/xinfu_db_backup_*.sql root@<新服务器IP>:/tmp/
```

#### 3.2 导入数据到新服务器

在**新服务器**上执行：

```bash
# 连接到新服务器
ssh root@<新服务器IP>

# 导入数据库
mysql -u xinfu_user -p'Xinfu2026@Secure' xinfu_db < /tmp/xinfu_db_backup_*.sql

# 验证数据导入
mysql -u xinfu_user -p'Xinfu2026@Secure' xinfu_db -e "
  SELECT COUNT(*) as user_count FROM app_user;
  SELECT COUNT(*) as profile_count FROM app_user_profile;
  SELECT COUNT(*) as assessment_count FROM assessment_record;
  SELECT COUNT(*) as match_batch_count FROM match_batch;
  SELECT COUNT(*) as service_track_count FROM service_track;
"

# 应该看到所有表的记录数，与旧服务器一致
```

**如果导入出错**：

```bash
# 查看错误日志
mysql -u xinfu_user -p'Xinfu2026@Secure' xinfu_db < /tmp/xinfu_db_backup_*.sql 2>&1 | tee import_error.log

# 常见问题：
# 1. 表已存在 -> 先删除表或使用 --force 选项
# 2. 字符集问题 -> 确保数据库字符集为 utf8mb4
# 3. 外键约束 -> 临时禁用外键检查
```

#### 3.3 重启服务

```bash
# 重启后端服务
cd /www/projects/xinfu-project
pm2 restart xinfu-backend

# 查看日志，确认无错误
pm2 logs xinfu-backend --lines 50

# 重启Nginx
systemctl restart nginx
```

---

### 第四步：验证迁移结果

#### 4.1 检查服务状态

```bash
# 检查PM2
pm2 list

# 检查Nginx
systemctl status nginx

# 检查端口
ss -tuln | grep -E ':3001|:8080'

# 应该看到3001和8080端口都在监听
```

#### 4.2 功能测试

**访问新服务器**：

1. **管理后台**: `http://<新服务器IP>:8080/admin`
   - 使用旧的账号密码登录
   - 检查用户列表是否显示
   - 检查匹配记录、测评记录

2. **H5前台**: `http://<新服务器IP>:8080/h5`
   - 尝试登录现有用户
   - 检查用户档案数据
   - 检查测评结果

3. **API测试**:
   ```bash
   # 在本地执行
   curl http://<新服务器IP>:8080/api/v1/users/app?page=1&limit=10
   
   # 应该返回用户列表数据
   ```

#### 4.3 数据完整性检查

登录管理后台后，检查：

- ✅ 用户列表数量是否与旧服务器一致
- ✅ 测评记录是否完整
- ✅ 匹配批次和候选人数据是否正确
- ✅ 服务轨迹记录是否保留
- ✅ 门店信息是否完整

---

## 🔄 方案B：服务器镜像/快照迁移（高级）

**优点**: 完整迁移所有内容，包括系统配置
**缺点**: 依赖云服务商支持，可能有兼容性问题

### 步骤概览

1. 在腾讯云控制台，对旧服务器创建"自定义镜像"
2. 使用该镜像创建新服务器实例
3. 修改新服务器的IP相关配置
4. 更新域名解析（如有）

**注意**: 此方案需要在腾讯云控制台操作，具体步骤请参考腾讯云文档。

---

## 🔧 迁移后配置更新

### 1. 更新配置文件中的IP地址

如果代码或配置中硬编码了旧服务器IP，需要更新：

```bash
# 在新服务器上执行
cd /www/projects/xinfu-project

# 检查配置文件
grep -r "115.159.58.73" backend/
grep -r "115.159.58.73" frontend-admin/dist/
grep -r "115.159.58.73" frontend-h5/dist/

# 如果有硬编码的IP，需要重新构建前端
cd frontend-admin
npm run build

cd ../frontend-h5
npm run build
```

### 2. 配置自动启动（推荐）

参考《完整部署指南.md》第九步，配置服务自动启动：

```bash
# 配置MySQL自动启动
systemctl enable mysqld

# 配置Redis自动启动（如果使用）
systemctl enable redis

# 配置Nginx自动启动
systemctl enable nginx

# 配置PM2自动启动
pm2 startup systemd
pm2 save
```

### 3. 更新域名解析（如有域名）

如果你使用了域名（如 `xingfuli.com`）：

1. 登录域名服务商后台（如阿里云、腾讯云DNS）
2. 修改A记录，指向新服务器IP
3. 等待DNS生效（通常5-10分钟）

---

## ⚠️ 注意事项

### 1. 数据备份的重要性

- ⚠️ **强制要求**: 在删除旧服务器前，**必须**确认新服务器数据完整且服务正常
- 💾 **双重备份**: 建议将数据库备份文件保存在至少2个地方（本地 + 云盘）
- 📅 **保留旧服务器**: 建议至少保留旧服务器7天，确认新服务器稳定后再释放

### 2. 密码和密钥管理

- 🔐 记录所有密码：MySQL root密码、xinfu_user密码、后台管理员密码
- 🔑 备份SSH私钥：`~/.ssh/xinfu_project`
- 📝 建议使用密码管理工具（如1Password、LastPass）

### 3. 性能和容量规划

- 📊 新服务器配置建议不低于旧服务器
- 💽 确认磁盘空间充足（至少20GB以上）
- 🧮 如果数据量大，考虑升级配置（4核8G或以上）

### 4. 安全配置

- 🛡️ 配置防火墙，只开放必要端口
- 🚫 禁用root密码登录，只允许密钥登录
- 🔒 定期更新系统补丁：`yum update`

---

## 📋 迁移清单（Checklist）

### 旧服务器操作
- [ ] 备份MySQL数据库（xinfu_db）
- [ ] 下载备份文件到本地
- [ ] 验证备份文件完整性（文件大小>0）
- [ ] 记录所有密码和配置

### 新服务器操作
- [ ] 购买并配置新服务器
- [ ] 配置安全组（开放8080端口）
- [ ] 配置SSH密钥
- [ ] 部署项目代码
- [ ] 安装并配置MySQL、Nginx、PM2
- [ ] 导入数据库备份
- [ ] 构建前端项目
- [ ] 启动后端服务

### 验证测试
- [ ] 访问管理后台并登录
- [ ] 检查用户列表数据
- [ ] 检查测评记录
- [ ] 检查匹配功能
- [ ] 访问H5前台并登录
- [ ] 测试核心功能
- [ ] 检查日志无错误

### 收尾工作
- [ ] 配置服务自动启动
- [ ] 更新域名解析（如有）
- [ ] 监控新服务器运行3-7天
- [ ] 确认稳定后释放旧服务器
- [ ] 删除临时备份文件

---

## 🆘 常见问题

### Q1: 数据库导入失败怎么办？

**A**: 
```bash
# 1. 检查备份文件是否完整
cat /tmp/xinfu_db_backup_*.sql | wc -l  # 应该有很多行

# 2. 尝试强制导入
mysql -u xinfu_user -p'Xinfu2026@Secure' xinfu_db --force < /tmp/xinfu_db_backup_*.sql

# 3. 查看具体错误
mysql -u xinfu_user -p'Xinfu2026@Secure' xinfu_db < /tmp/xinfu_db_backup_*.sql 2>&1 | grep ERROR
```

### Q2: 前端页面404怎么办？

**A**: 
```bash
# 检查前端文件是否存在
ls -la /www/projects/xinfu-project/frontend-admin/dist/
ls -la /www/projects/xinfu-project/frontend-h5/dist/

# 如果dist目录为空，重新构建
cd /www/projects/xinfu-project/frontend-admin
npm install
npm run build

# 检查Nginx配置
nginx -t
cat /etc/nginx/conf.d/xinfu-project.conf
```

### Q3: 后端API返回500错误？

**A**: 
```bash
# 查看后端日志
pm2 logs xinfu-backend --lines 100

# 常见原因：
# 1. 数据库连接失败 -> 检查.env配置
# 2. 表不存在 -> 重新导入数据库
# 3. 端口冲突 -> 检查3001端口是否被占用
```

### Q4: 忘记MySQL密码怎么办？

**A**: 
```bash
# 如果还能访问旧服务器
ssh root@115.159.58.73
cat /www/projects/xinfu-project/backend/.env | grep DB_PASSWORD

# 如果丢失，需要重置MySQL密码（参考网上教程）
```

---

## 📞 技术支持

如果迁移过程中遇到问题：

1. **查看日志**: 
   - 后端: `pm2 logs xinfu-backend`
   - Nginx: `tail -f /var/log/nginx/xinfu-error.log`
   - MySQL: `tail -f /var/log/mysqld.log`

2. **检查配置**: 
   - 核对所有配置文件中的IP、端口、密码
   - 确认文件权限正确

3. **回滚方案**: 
   - 如果新服务器问题无法解决，可暂时继续使用旧服务器
   - 保留旧服务器的备份和快照

---

**最后更新**: 2026-01-22  
**适用版本**: 幸福力婚恋系统 v1.0  
**预计迁移时间**: 1-2小时（取决于数据量和网络速度）
