# 后台角色权限测试说明

## 📋 权限规则总览

### 1. 角色修改权限

| 当前角色 | 可以修改谁 | 可以设置的角色 | 限制 |
|---------|----------|--------------|------|
| **超级管理员** | 所有人（除自己） | admin, manager, matchmaker | ✅ 跨门店操作<br>❌ 不能修改自己<br>⚠️ **不能设置为超级管理员（超管唯一，仅系统预设）** |
| **门店老板** | 本门店的负责人和红娘 | manager, matchmaker | ✅ 仅限本门店<br>❌ 不能修改自己<br>❌ 不能修改超级管理员<br>❌ 不能修改其他门店老板<br>❌ 不能提升用户为老板 |
| **门店负责人** | ❌ 无权限 | - | 只能查看，不能修改 |
| **普通红娘** | ❌ 无权限 | - | 只能查看，不能修改 |

### 🔒 超级管理员唯一性保护

- **超级管理员账号**：系统仅有一个，预设在数据库初始化脚本中（`database/03_init_data.sql`）
- **账号信息**：`username: super_admin`, `id: SUPER_ADMIN`, `store_id: NULL`
- **创建方式**：只能通过直接操作数据库创建，不允许通过任何界面操作
- **保护措施**：
  - ✅ 注册时不允许选择超级管理员角色
  - ✅ 修改角色时不显示超级管理员选项
  - ✅ 后端API强制校验，拒绝设置超级管理员角色
  - ✅ 超级管理员不能修改自己的角色（防止误操作）

### 2. 账号状态管理权限 (禁用/启用)

| 角色 | 可以操作谁 | 限制 |
|------|----------|------|
| **超级管理员** | 所有人（除自己） | 全局权限 |
| **门店老板** | 本门店的负责人和红娘 | ✅ 仅限本门店<br>❌ 不能操作自己<br>❌ 不能操作超级管理员<br>❌ 不能操作其他门店老板 |
| **其他角色** | ❌ 无权限 | - |

### 3. 用户审核权限

| 角色 | 可以审核谁 | 限制 |
|------|----------|------|
| **超级管理员** | 所有待审核用户 | 全局权限 |
| **门店老板** | 本门店的负责人和红娘申请 | ❌ 不能审核老板或超级管理员角色的申请 |
| **其他角色** | ❌ 无权限 | - |

### 4. 密码重置权限

| 角色 | 可以重置谁的密码 | 限制 |
|------|----------------|------|
| **超级管理员** | 所有人 | 全局权限 |
| **其他角色** | ❌ 无权限 | - |

## 🧪 测试场景

### 场景1：超级管理员登录

**测试步骤**：
1. 使用超级管理员账号登录：`super_admin` / `admin654321`
2. 进入"人员列表"页面
3. 查看所有用户的操作按钮

**预期结果**：
- ✅ 可以看到所有用户（包括其他门店的用户）
- ✅ 除了自己的记录外，其他记录都显示"修改角色"、"禁用/启用"、"重置密码"按钮
- ✅ 自己的记录显示"无操作权限"
- ✅ 点击"修改角色"时，只能选择三个角色（**admin, manager, matchmaker，不包括 super_admin**）

### 场景2：门店老板登录

**测试账号**：需要先创建一个门店老板账号
1. 注册一个新账号，角色选择"门店老板"
2. 用超级管理员审核通过

**测试步骤**：
1. 使用门店老板账号登录
2. 进入"人员列表"页面
3. 尝试修改不同用户的角色

**预期结果**：
- ✅ 只能看到本门店的用户
- ✅ 自己的记录显示"无操作权限"
- ✅ 本门店的负责人和红娘显示"修改角色"、"禁用/启用"按钮
- ❌ 没有"重置密码"按钮（只有超管有）
- ✅ 点击"修改角色"时，只能选择"门店负责人"或"普通红娘"
- ❌ 尝试修改超级管理员 → 前端不显示操作按钮
- ❌ 尝试修改其他门店老板 → 前端不显示操作按钮

### 场景3：门店老板尝试提升自己（Bug测试）

**测试步骤**：
1. 用门店老板账号登录
2. 进入"人员列表"页面
3. 查看自己的记录

**预期结果**：
- ✅ 自己的记录显示"无操作权限"
- ✅ 没有任何操作按钮（修改角色、禁用、重置密码都不显示）

### 场景4：通过API直接调用测试后端拦截

**测试方法**：使用浏览器控制台或Postman

```javascript
// 场景4.1：尝试修改自己的角色
await axios.patch('/api/v1/users/sys/XFL001G00001/role', { role: 'manager' })
// 预期：返回 403 "不能修改自己的角色"

// 场景4.2：门店老板尝试提升用户为老板
await axios.patch('/api/v1/users/sys/XFL001G00002/role', { role: 'admin' })
// 预期：返回 403 "门店老板无权提升用户为老板或超级管理员"

// 场景4.3：门店老板尝试修改其他门店用户
await axios.patch('/api/v1/users/sys/XFL002G00001/role', { role: 'manager' })
// 预期：返回 403 "无权修改其他门店用户的角色"

// 场景4.4：门店负责人尝试修改任何人
await axios.patch('/api/v1/users/sys/XFL001G00002/role', { role: 'matchmaker' })
// 预期：返回 403 或 401（应该在Controller层被RolesGuard拦截）

// 场景4.5：超级管理员尝试将用户设置为超级管理员
await axios.patch('/api/v1/users/sys/XFL001G00001/role', { role: 'super_admin' })
// 预期：返回 403 "超级管理员角色只能通过系统预设，不允许通过界面设置"

// 场景4.6：注册时尝试申请超级管理员角色
await axios.post('/api/v1/users/register/sys', { 
  username: 'test', 
  password: '123456', 
  name: '测试',
  idCard: '440111199001011234',
  phone: '13800138000',
  storeId: 'XFL001',
  role: 'super_admin',
  agreeToTerms: true
})
// 预期：返回 400 "超级管理员角色只能通过系统预设，不允许注册"
```

## ✅ 验收标准

### 前端UI层面：
- [ ] 超级管理员看不到修改自己的操作按钮
- [ ] 门店老板看不到修改自己的操作按钮
- [ ] 门店老板看不到修改超级管理员或其他老板的操作按钮
- [ ] 门店老板修改角色时，下拉框只有"负责人"和"红娘"
- [ ] 超级管理员修改角色时，下拉框只有"门店老板"、"负责人"和"红娘"（不包括超级管理员）
- [ ] 注册表单中申请角色下拉框不包含"超级管理员"选项
- [ ] 负责人和红娘看到所有记录都是"无操作权限"

### 后端API层面：
- [ ] 任何人尝试修改自己的角色都返回403
- [ ] 任何人（包括超级管理员）尝试将用户设置为超级管理员都返回403
- [ ] 任何人尝试注册超级管理员角色都返回400
- [ ] 门店老板尝试提升用户为老板返回403
- [ ] 门店老板尝试跨门店操作返回403
- [ ] 负责人和红娘调用角色修改API返回403或401

## 🐛 已知Bug修复

### Bug #1：门店老板可以修改自己的角色
- **状态**：✅ 已修复
- **修复内容**：
  - 后端：`user.service.ts` 第143行添加检查 `if (targetUser.id === currentUser.id)`
  - 前端：`StaffList.vue` 添加 `canEditRole()` 函数，对自己的记录不显示操作按钮

### Bug #2：门店老板可以将自己提升为超级管理员
- **状态**：✅ 已修复
- **修复内容**：
  - 后端：`user.service.ts` 第167行检查目标角色，拒绝设置为 admin 或 super_admin
  - 前端：`StaffList.vue` 根据当前用户角色动态生成可选角色列表

### 安全特性 #3：超级管理员唯一性保护
- **状态**：✅ 已实现
- **实现内容**：
  - 后端注册：`user.service.ts` 在 `registerSysUser` 中拒绝注册为超级管理员
  - 后端角色修改：`user.service.ts` 在 `updateSysUserRole` 中拒绝将任何用户设置为超级管理员
  - 前端注册：`LoginView.vue` 注册表单不显示超级管理员选项
  - 前端角色修改：`StaffList.vue` 角色下拉框不包含超级管理员选项（即使是超管修改他人角色）
- **设计理念**：超级管理员是系统唯一的特殊账号，只能通过数据库脚本预设，确保系统安全

## 📝 注意事项

1. **前后端双重防护**：即使前端隐藏了操作按钮，后端仍会严格校验权限
2. **错误提示**：后端返回的错误信息会在前端显示，帮助用户理解为什么操作失败
3. **审计日志**：建议在后端添加操作日志，记录所有角色修改操作（TODO）

## 🚀 测试执行时间

建议在以下情况执行完整测试：
- ✅ 新功能上线前
- ✅ 权限相关代码修改后
- ✅ 定期安全审计时

