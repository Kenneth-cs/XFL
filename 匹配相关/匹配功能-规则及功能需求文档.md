# PRD：相亲后台用户匹配模块


## 一、模块概述
本模块是相亲后台的核心功能之一，用于为前台用户提供精准匹配服务：**基于用户所在门店实现数据隔离（仅筛选同门店前台用户）**，排除已与发起方存在服务登记的用户后（服务轨迹-匹配轨迹、约见轨迹里的记录），结合筛选条件+MV值+九型人格完成匹配运算；
匹配结果列表将**按匹配时间分批次展示每次发起匹配的记录**（批次按匹配时间倒序排列），同时支持通过发起方 / 被发起方信息筛选匹配记录，实现匹配操作的批次化管理、精准查询与结果区分，最终展示匹配结果及双方详情。


## 二、功能需求
### 7.3 核心规则：门店数据隔离
系统仅筛选**与发起匹配的用户处于同一门店**的前台用户，不同门店的前台用户不纳入匹配范围。


### 7.3.1 发起匹配&筛选功能
1. **操作入口**：后台「用户档案管理-智能匹配-发起匹配」页面
2. **发起匹配流程**：
   - 搜索「发起方用户姓名/手机号」，选中搜索结果的用户信息（用户ID、用户姓名、用户手机号、性别）；
   - 设置筛选条件：
     - 年龄：配置「最低年龄」「最高年龄」区间；
     - 身高：配置「最低身高」「最高身高」区间；
     - 学历：配置「最低学历」「最高学历」层级；
   - 点击「确定」触发筛选。
3. **排除规则**：已与发起方存在「服务登记记录」的用户（用户档案中有相关模块，服务轨迹-匹配轨迹、服务轨迹-约见轨迹中双方信息建立了关联/任务记录的），不纳入候选方列表。


### 7.3.2 匹配运算功能
系统对初步筛选后的候选方，自动执行以下维度运算：
1. **MV值匹配**：
   - 规则：以发起方MV值为基准，计算候选方与发起方的总分差值；**|差值|≤5分则“通过”，超出则“不通过”**；
   - MV值计算规则参考“MV值分地域计算方案及结果计算说明.md”文档
   - 关联展示：婚恋价值匹配结果（是否通过）、婚恋价值匹配得分。
2. **九型人格匹配**：
   - 规则：比对发起方与候选方的九型人格测试结果，**性格相符则“通过”，不符则“不通过”**，并显示发起方和匹配方（候选方）适合的性格有多少种重合；
   - 九型人格计算规则参考“九型人格匹配规则说明.md”文档
   - 关联展示：性格匹配结果（是否通过）。


### 7.3.3 匹配结果展示
1. **列表页展示（含批次逻辑）**：
   - **批次分组**：以“匹配时间：YYYY-MM-DD HH:MM:SS”为标题（醒目样式，如绿色字体）聚合同一次发起匹配的结果，批次按匹配时间**倒序排列**（最新批次展示在列表顶部）；
   - **批次内内容**：
     - 发起方信息：ID、姓名；
     - 所有候选方信息：ID、姓名；
     - 幸福力圆环：发起方幸福力测试圆环图结果、候选方测试圆环图结果
     - 匹配状态：双方MV值匹配结果（通过或者不通过）、双方九型人格匹配结果（通过或者不通过），并显示发起方和匹配方（候选方）适合的性格有多少种重合；
     - 匹配分数：双方MV值婚恋价值匹配得分；
     - 双方九型人格测试的结果（从`有效人格列表`中，选取**百分比最高的3个**）
     - 操作按钮：「查看详情」；
   - **批次区分**：通过间距、浅背景色等视觉元素分隔不同批次，避免结果混淆。
2. **详情页展示内容**：
   - 点击「查看详情」后，分左右两边展示匹配双方的用户档案信息，如：姓名、年龄、身高、学历等完整资料（服务轨迹、匹配轨迹、约见轨迹、治疗轨迹除外）。详情参考“用户档案模块信息字段及说明.md”

### 7.3.4 匹配结果查询筛选功能
1. **操作入口与筛选项**：
   - 操作入口：匹配结果列表页顶部的筛选查询区域
   - 筛选项（支持模糊输入）：
     - 发起方维度：发起方姓名、发起方 ID、发起方手机号
     - 被发起方（候选方）维度：被发起方姓名、被发起方 ID、被发起方手机号
2. **操作按钮**：
   - 「查询」：点击后系统根据输入条件，过滤匹配结果列表，展示符合条件的记录
   - 「重置」：点击后清空所有筛选输入框内容，恢复展示全部匹配记录

## 三、交互流程
1. 进入页面：后台人员从左侧菜单进入「用户档案管理-智能匹配-发起匹配」；
2. 发起匹配：在弹窗录入发起方ID或者手机号、选择候选方、设置筛选条件，点击「确定」；
3. 系统运算：先按“门店隔离+筛选条件”过滤候选方→排除有服务登记的用户→自动计算MV值+九型人格匹配结果→生成该次匹配的批次记录；
4. 查看列表：系统按匹配时间倒序展示批次化的匹配结果列表，每个批次聚合对应发起操作的候选方结果；
5. 查看详情：点击某候选方的「查看详情」，跳转至详情页查看双方完整资料。


## 四、数据规则
1. **门店隔离逻辑**：候选方数据仅取自「发起方所属门店的前台用户表」，跨门店数据不关联；
2. **服务轨迹登记排除逻辑**：通过「服务轨迹登记记录表」关联发起方ID与候选方ID，存在关联记录则排除（用户档案中有相关模块，服务轨迹-匹配轨迹、服务轨迹-约见轨迹中双方信息建立了关联/任务记录的，排除）；
3. **筛选条件逻辑**：
   - 年龄/身高：候选方数据需处于发起方设置的「最低-最高」区间内；
   - 学历：候选方学历需介于发起方设置的「最低学历-最高学历」层级之间；
4. **匹配运算逻辑**：
   - MV值：差值=候选方MV值-发起方MV值，|差值|≤5 → 通过；
   - 九型人格：匹配原则采用加分减分制，有-1分的都是绝对不通过匹配
        例如：A男结果数据单项百分比超出占比前3位，是1号，3号，5号，则对应匹配异性（女生）的九型人格为
            女1号	女2号	女3号	女4号	女5号	女6号	女7号	女8号	女9号
        男1号	0	0	+1	0	+1	0	-1	+1	+1
        男3号	+1	0	0	0	0	-1	+1	+1	+1
        男5号	+1	+1	0	+1	+1	0	0	+1	-1
        合计	2	1	1	1	2	-1	0	3	1

        结论：A男适合的女生性格包含女8（**型），女5（**型），女1（**型），女2（**型），女3（**型），女4（**型）（按优先顺序进行排序）
        完全不适合的是女6（**型），女7（**型），女9（**型）,（即有减分项作为必要互斥项绝对不可匹配）。

        最后看该候选方属于哪几种主要有效的九型人格类型，进行是否通过匹配计算，筛选通过后显示发起方和匹配方（候选方）适合的性格有多少种重合

5. **匹配批次存储逻辑**：每次发起匹配操作生成一条“匹配批次记录”，自动关联：
   - 该次匹配的时间；
   - 发起方ID；
   - 发起方姓名；
   - 该次匹配下的所有候选方匹配结果；
   批次以“匹配时间”作为唯一标识，支持按时间追溯历史匹配操作。

6. **匹配结果查询逻辑**：
    - 筛选项支持模糊匹配（输入片段内容即可匹配包含该片段的记录）；
    - 多筛选项同时输入时，系统执行 “且” 逻辑，仅展示同时满足所有条件的记录。



## 五、界面原型说明
1. **选择匹配弹窗**：包含“发起方ID录入框”“候选方选择区”“年龄/身高/学历筛选项”“取消/确定按钮”；
2.
    
2. **匹配结果列表页**：
   - 标题为「用户档案-智能匹配」，左侧为后台菜单；
   - 顶部筛选查询区域：包含 “发起方姓名、发起方 ID、发起方手机号、被发起方姓名、被发起方 ID、被发起方手机号” 输入框，以及「查询」「重置」按钮；
   - 中部：按倒序展示“匹配时间”批次标题（绿色醒目样式）；
   - 每个批次下呈现对应候选方的信息、双方幸福力圆环测试结果图、匹配结果、分数、双方九型人格及重合人格数量、「查看详情」按钮，批次间用浅背景色 + 间距分隔；
3. **匹配详情页**：展示双方姓名、年龄、身高、学历等用户档案的资料，保留后台通用操作栏（如用户账号、退出登录）。

